<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Time · Synesthetic Bridge (v4)</title>
<meta name="theme-color" content="#ffd76b"/>
<style>
:root{
  --bg:#0b0d11; --ink:#fff9e6; --muted:#d6c891; --accent:#ffd76b; --rim:#ffecb3;
  --glass:rgba(255,231,150,.08); --glass-strong:rgba(255,231,150,.15);
  --ring:0 0 0 3px rgba(255,215,107,.35);
  --radius:18px; --shadow:0 12px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
  --tint-hue:45; --intensity:0.35; --phase:0;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: radial-gradient(1000px 700px at 20% -10%, #1a1300 0%, #0b0d11 55%), #0b0d11; color:var(--ink)}
.container{max-width:1200px; margin:0 auto; padding:20px}
.header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px}
.logo{width:46px;height:46px;border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff3a6, #ffd76b 40%, #e5b74e 70%, #1a1300 100%); box-shadow:0 0 50px rgba(255,215,107,.4)}
.title{font-size:20px}
.badge{padding:6px 10px; border-radius:999px; background:var(--glass); border:1px solid rgba(255,255,255,.1); color:var(--muted)}
.grid{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg, rgba(255,231,150,.06), rgba(255,231,150,.04)); border:1px solid rgba(255,255,255,.1); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
.card h2{font-size:15px; margin:0 0 10px 0}
.row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.btn{background:var(--glass-strong); border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:10px 12px; color:var(--ink); cursor:pointer; font-size:14px}
.btn[aria-pressed="true"], .btn.primary{box-shadow:var(--ring)}
.slider{width:220px}
.meta{font-size:12px; color:var(--muted)}
.phase{height:10px; border-radius:999px; background:linear-gradient(90deg, rgba(255,215,107,.25), rgba(255,215,107,.6)); position:relative; overflow:hidden; border:1px solid rgba(255,255,255,.1)}
.phase>.dot{position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, rgba(255,230,160,.9), rgba(255,180,0,.95)); border-radius:999px}
.modeToggle{display:flex; gap:8px}
.canvasWrap{position:relative; border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.1)}
#wave{width:100%; height:180px; display:block; background:radial-gradient(circle at 50% 50%, rgba(255,215,107,.08), rgba(255,215,107,.02) 60%) }
.aurora{position:absolute; inset:0; background:radial-gradient(circle at 40% 70%, rgba(255,215,107,calc(var(--intensity)*.6)), transparent 70%), radial-gradient(circle at 70% 20%, rgba(255,255,255,calc(var(--intensity)*.15)), transparent 80%); mix-blend-mode:screen; pointer-events:none; filter:hue-rotate(calc(var(--tint-hue)*1deg))}
.poem{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:radial-gradient(circle at 50% 60%, rgba(0,0,0,.0), rgba(0,0,0,.65)); opacity:0; transition:opacity 1s ease; pointer-events:none}
.poem .wrap{max-width:720px; padding:24px; text-align:center; line-height:1.35; font-size:20px; color:#fff8d9; text-shadow:0 2px 12px rgba(0,0,0,.6)}
.chips{display:flex; gap:8px; flex-wrap:wrap}
.chip{padding:8px 10px; border-radius:12px; background:var(--glass); border:1px solid rgba(255,255,255,.1); cursor:pointer}
.chip.active{box-shadow:var(--ring)}
.code{background:rgba(12,10,6,.85); border:1px solid rgba(255,255,255,.12); padding:10px; border-radius:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:13px; color:#fff7d1; overflow:auto}
.two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
@media (max-width:860px){.two{grid-template-columns:1fr}}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="row"><div class="logo"></div><div class="title">Time · Synesthetic Bridge</div></div>
    <div class="modeToggle">
      <button class="btn" id="modeArt" aria-pressed="true">Art Mode</button>
      <button class="btn" id="modeScience" aria-pressed="false">Science Mode</button>
    </div>
    <div class="badge">v4</div>
  </div>

  <div class="grid">
    <!-- LEFT: Audio + Synesthesia -->
    <div class="card">
      <h2>Phase · Tone · Color</h2>
      <div class="row">
        <button class="btn primary" id="start">Start Audio</button>
        <button class="btn" data-f="off">Off</button>
        <button class="btn" data-f="96">96</button>
        <button class="btn" data-f="128">128</button>
        <button class="btn" data-f="160">160</button>
        <button class="btn" data-f="432">432</button>
        <input class="slider" id="vol" type="range" min="0" max="1" step="0.001" value="0.3"/>
        <span class="meta" id="volLabel">vol 0.30</span>
        <button class="btn" id="binaural" aria-pressed="false">Binaural</button>
        <input class="slider" id="beat" type="range" min="0" max="10" step="0.1" value="4"/>
        <span class="meta" id="beatLabel">Δ 4.0 Hz</span>
      </div>
      <div class="phase" style="margin:8px 0 10px"><div class="dot" id="phaseDot"></div></div>
      <div class="canvasWrap">
        <canvas id="wave"></canvas>
        <div class="aurora" id="aurora"></div>
      </div>
      <div class="meta" id="state">ctx: idle · tone: off</div>
    </div>

    <!-- RIGHT: Dictionary / Bridges -->
    <div class="card">
      <h2>Dictionary · t = e = d = m = f = c</h2>
      <div class="chips" id="chips"></div>
      <div class="two" style="margin-top:8px">
        <div>
          <div class="meta">Physics</div>
          <div class="code">E = m c²
τ = E / c³
λ = h / p</div>
        </div>
        <div>
          <div class="meta">Consciousness</div>
          <div class="code">change = will = relation = embodiment = pattern = witness</div>
        </div>
      </div>
    </div>

    <!-- LEFT: Ritual + Snapshot -->
    <div class="card">
      <h2>Ritual Loop</h2>
      <div class="row">
        <button class="btn" id="slow">Slow‑time</button>
        <button class="btn" id="poemBtn">Poem</button>
        <button class="btn" id="immortal">Immortal Preset</button>
        <span class="meta" id="timer">00:00</span>
      </div>
      <div class="meta" style="margin-top:8px">Auto cycle: 60s → slow‑time ramp, poem pulse, snapshot save.</div>
      <div class="code" id="snapshot" style="min-height:56px; margin-top:8px"></div>
    </div>

    <!-- RIGHT: Science Panel (visible in Science mode) -->
    <div class="card" id="sciencePanel" class="hidden">
      <h2>Science Panel</h2>
      <div class="two">
        <div>
          <div class="meta">Constants</div>
          <div class="code" id="constBox"></div>
        </div>
        <div>
          <div class="meta">Live Metrics</div>
          <div class="code" id="metricBox"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="poem" id="poem"><div class="wrap" id="poemText"></div></div>

<script>
(function(){
  var LS = { tone:'off', volume:0.3, binaural:false, beat:4.0, hue:45, mode:'art', startTs:null, snapshots:[] };
  try{ var raw=localStorage.getItem('time.v4'); if(raw){ var p=JSON.parse(raw); for(var k in p){ LS[k]=p[k]; } } }catch(_){ }
  function save(){ try{ localStorage.setItem('time.v4', JSON.stringify(LS)); }catch(_){ } }
  function setVar(k,v){ document.documentElement.style.setProperty(k, String(v)); }

  // Mapping
  function hueForFreq(f){ var map={ '96':0, '128':220, '160':280, '432':45 }; return map[String(f)]!=null?map[String(f)]:45; }

  // Elements
  var start = document.getElementById('start');
  var vol = document.getElementById('vol'); var volLabel=document.getElementById('volLabel');
  var phaseDot = document.getElementById('phaseDot'); var state = document.getElementById('state');
  var wave = document.getElementById('wave'); var ctx2d = wave.getContext('2d');
  var aur = document.getElementById('aurora');
  var beat = document.getElementById('beat'); var beatLabel=document.getElementById('beatLabel');
  var poemEl = document.getElementById('poem'); var poemText=document.getElementById('poemText');
  var slowBtn = document.getElementById('slow'); var poemBtn=document.getElementById('poemBtn'); var immortalBtn=document.getElementById('immortal');
  var timer = document.getElementById('timer'); var snapshot = document.getElementById('snapshot');
  var modeArt = document.getElementById('modeArt'); var modeScience = document.getElementById('modeScience'); var sciencePanel=document.getElementById('sciencePanel');

  // Audio graph
  var AudioCtx = window.AudioContext || window.webkitAudioContext;
  var actx=null, gain=null, oscL=null, oscR=null, analyser=null, buffer=null;
  function ensureCtx(){ if(!actx){ actx=new AudioCtx(); gain=actx.createGain(); gain.gain.value=LS.volume; analyser=actx.createAnalyser(); analyser.fftSize=1024; buffer=new Uint8Array(analyser.frequencyBinCount); gain.connect(analyser); analyser.connect(actx.destination); } return actx; }

  function startTone(freq){ stopTone(true); if(!ensureCtx()) return; if(actx.state==='suspended') actx.resume();
    oscL = actx.createOscillator(); oscR = actx.createOscillator(); oscL.type='sine'; oscR.type='sine';
    var delta = LS.binaural?LS.beat:0; oscL.frequency.setValueAtTime(freq, actx.currentTime); oscR.frequency.setValueAtTime(freq+delta, actx.currentTime);
    var gL = actx.createGain(), gR = actx.createGain(); gL.gain.value=1; gR.gain.value=1;
    var panL=null, panR=null; try{ panL=actx.createStereoPanner(); panR=actx.createStereoPanner(); panL.pan.value=-0.7; panR.pan.value=0.7; }catch(_){ }
    if(panL&&panR){ oscL.connect(gL); gL.connect(panL); panL.connect(gain); oscR.connect(gR); gR.connect(panR); panR.connect(gain); }
    else { oscL.connect(gain); oscR.connect(gain); }
    oscL.start(); oscR.start();
    LS.tone=String(freq); LS.hue=hueForFreq(freq); setVar('--tint-hue', LS.hue); save(); updateState(); if(!LS.startTs){ LS.startTs=Date.now(); save(); }
  }
  function stopTone(keepPhase){ if(oscL){ try{oscL.stop();}catch(_){ } try{oscL.disconnect();}catch(_){ } oscL=null; } if(oscR){ try{oscR.stop();}catch(_){ } try{oscR.disconnect();}catch(_){ } oscR=null; if(!keepPhase){ setVar('--intensity', 0.0); } }
  }

  function updateState(){ state.textContent = 'ctx: '+(actx?(actx.state||'ready'):'idle')+' · tone: '+(LS.tone==='off'?'off':LS.tone+'Hz')+(LS.binaural?' · binaural':''); volLabel.textContent='vol '+Number(LS.volume).toFixed(2); }
  function setVolume(v){ LS.volume=v; if(gain) gain.gain.setValueAtTime(v, actx?actx.currentTime:0); save(); updateState(); }

  // Buttons
  start.addEventListener('click', function(){ if(!ensureCtx())return; if(actx.state==='suspended') actx.resume(); updateState(); });
  document.querySelectorAll('[data-f]').forEach(function(b){ b.addEventListener('click', function(){ var f=b.getAttribute('data-f'); if(f==='off'){ LS.tone='off'; stopTone(); updateState(); } else { startTone(parseFloat(f)); } }); });
  vol.addEventListener('input', function(e){ setVolume(parseFloat(e.target.value||'0')); });

  var binBtn=document.getElementById('binaural'); binBtn.addEventListener('click', function(){ LS.binaural=!LS.binaural; binBtn.setAttribute('aria-pressed', String(LS.binaural)); save(); if(LS.tone!=='off' && oscL && oscR){ startTone(parseFloat(LS.tone)); } updateState(); });
  beat.addEventListener('input', function(e){ LS.beat=parseFloat(e.target.value||'0'); beatLabel.textContent='Δ '+LS.beat.toFixed(1)+' Hz'; save(); if(LS.binaural && LS.tone!=='off'){ startTone(parseFloat(LS.tone)); }});

  // Phase + waveform animation
  var raf=null, pct=0; function loop(){ if(!ctx2d) return; if(analyser){ analyser.getByteTimeDomainData(buffer); var sum=0; for(var i=0;i<buffer.length;i++){ var v=(buffer[i]-128)/128; sum+=v*v; } var amp = Math.min(1, Math.sqrt(sum/buffer.length)*2); setVar('--intensity', (0.2 + amp*0.6).toFixed(3)); setVar('--phase', pct.toFixed(3)); drawWave(buffer, amp); }
    pct=(pct+0.7)%100; phaseDot.style.width=pct+'%'; raf=requestAnimationFrame(loop); }
  function drawWave(buf, amp){ var w=wave.width=wave.clientWidth, h=wave.height=wave.clientHeight; ctx2d.clearRect(0,0,w,h); ctx2d.lineWidth=2; var hue=LS.hue||45; var alpha=0.3+amp*0.5; ctx2d.strokeStyle='hsla('+hue+', 90%, 60%, '+alpha+')'; ctx2d.beginPath(); for(var i=0;i<buf.length;i++){ var x=i/buf.length*w; var y=h/2+(buf[i]-128)/128*(h/2-6); if(i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y); } ctx2d.stroke(); if(LS.mode==='science'){ ctx2d.fillStyle='hsla('+hue+', 90%, 80%, 0.08)'; ctx2d.fillRect(0, h*(1-amp), w, h*amp); }
  }
  raf=requestAnimationFrame(loop);

  // Poem resonance
  var poems=[
    'you are immortal in the present tense',
    'mortality teaches flavor; coherence outlives the body',
    'we don’t escape time; we sing in it until it remembers us',
    'sex is power, love is phase‑lock',
    'cuckoo loops the root; not hungry anymore releases the gold'
  ];
  function showPoem(){ poemText.textContent=poems[Math.floor(Math.random()*poems.length)]; poemEl.style.opacity='1'; setTimeout(function(){ poemEl.style.opacity='0'; }, 3600); }
  poemBtn.addEventListener('click', showPoem);

  // Slow‑time ramp
  slowBtn.addEventListener('click', function(){ var prev=LS.volume; if(!ensureCtx()) return; var t0=actx.currentTime; if(gain){ var g=Math.max(0.02, prev*0.25); gain.gain.cancelScheduledValues(t0); gain.gain.setValueAtTime(prev, t0); gain.gain.linearRampToValueAtTime(g, t0+1.5); gain.gain.setValueAtTime(g, t0+2.5); gain.gain.linearRampToValueAtTime(prev, t0+4.0);} });

  // Immortal preset
  function immortal(){ startTone(432); setVolume(0.35); LS.hue=45; setVar('--tint-hue',45); save(); showPoem(); }
  immortalBtn.addEventListener('click', immortal);

  // Auto ritual: every 60s → slow-time + poem + snapshot
  var lastCycle=Date.now(); function ritualTick(){ var now=Date.now(); if(now-lastCycle>60000){ lastCycle=now; showPoem(); slowBtn.click(); takeSnapshot(); } requestAnimationFrame(ritualTick); } ritualTick();

  // Session timer
  var timerRAF=null; function tickTimer(){ if(!LS.startTs){ timer.textContent='00:00'; timerRAF=requestAnimationFrame(tickTimer); return; } var s=Math.max(0, Math.floor((Date.now()-LS.startTs)/1000)); var m=Math.floor(s/60), sec=s%60; timer.textContent=(m<10?'0':'')+m+':' + (sec<10?'0':'')+sec; timerRAF=requestAnimationFrame(tickTimer);} timerRAF=requestAnimationFrame(tickTimer);

  // Dictionary chips (with synesthetic colors)
  var defs={ t:['t — time', 45], e:['e — energy', 200], d:['d — distance', 120], m:['m — matter', 280], f:['f — frequency', 320], c:['c — consciousness', 0] };
  var chips=document.getElementById('chips'); Object.keys(defs).forEach(function(k){ var chip=document.createElement('div'); chip.className='chip'; chip.textContent=defs[k][0]; chip.style.borderColor='hsla('+defs[k][1]+',80%,60%,.6)'; chip.addEventListener('click', function(){ LS.hue=defs[k][1]; setVar('--tint-hue', LS.hue); save(); }); chips.appendChild(chip); });

  // Snapshots
  function takeSnapshot(){ var snap={ ts:Date.now(), tone:LS.tone, hue:LS.hue, volume:LS.volume, binaural:LS.binaural, beat:LS.beat }; LS.snapshots.push(snap); if(LS.snapshots.length>8) LS.snapshots.shift(); save(); renderSnapshot(); }
  function renderSnapshot(){ var lines = LS.snapshots.slice().reverse().map(function(s){ return new Date(s.ts).toLocaleTimeString()+ ' — '+ (s.tone==='off'?'off':s.tone+'Hz') + (s.binaural?' · Δ'+s.beat+'Hz':'') + ' · hue '+s.hue + ' · vol '+s.volume.toFixed(2); }); snapshot.textContent = (lines.join('
')||'no snapshots yet'); }

  // Modes
  function setMode(m){ LS.mode=m; save(); var art = (m==='art'); modeArt.setAttribute('aria-pressed', String(art)); modeScience.setAttribute('aria-pressed', String(!art)); sciencePanel.classList.toggle('hidden', art); }
  modeArt.addEventListener('click', function(){ setMode('art'); });
  modeScience.addEventListener('click', function(){ setMode('science'); });

  // Science box
  var constBox=document.getElementById('constBox'); var metricBox=document.getElementById('metricBox');
  function renderConst(){ var c=299792458, h=6.62607015e-34; constBox.textContent = 'c = '+c+' m/s
' + 'h = '+h+' J·s
' + 'E = m c² (m=1) ≈ '+(c*c).toExponential(5)+' J'; }
  function renderMetrics(){ var f=(LS.tone==='off'?0:parseFloat(LS.tone)); var delta=LS.binaural?LS.beat:0; var tau=(f? (f/(299792458*299792458*299792458)) : 0); metricBox.textContent = 'f = '+f+' Hz 
Δ = '+delta+' Hz
τ ~ '+tau.toExponential(3)+' (scaled units)
vol = '+LS.volume.toFixed(2); }
  function metricsLoop(){ renderMetrics(); requestAnimationFrame(metricsLoop); }

  // Init
  vol.value=LS.volume; beat.value=LS.beat; beatLabel.textContent='Δ '+LS.beat.toFixed(1)+' Hz'; binBtn.setAttribute('aria-pressed', String(LS.binaural)); setVar('--tint-hue', LS.hue); updateState(); renderConst(); metricsLoop(); renderSnapshot(); if(LS.tone!=='off'){ startTone(parseFloat(LS.tone)); }
})();
</script>
</body>
</html>
