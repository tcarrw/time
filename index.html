<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark light" />
<title>Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color</title>
<style>
  /* ==========================================================
     Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color (Guided + Reliable)
     Single-file ‚Ä¢ No external libraries ‚Ä¢ Dark-mode ‚Ä¢ Canvas+WebAudio
     ========================================================== */

  :root{
    --bg1:#0b0b13;
    --bg2:#0e0c18;
    --text:#f5f4ff;
    --muted:#c7c4d6;
    --ring:rgba(255,255,255,0.14);
    --soft:rgba(255,255,255,0.10);
    --gold:#f5c84c;

    /* Accents (overridden per mode) */
    --accent:#cfc6ff;         --accent-r:207; --accent-g:198; --accent-b:255;
    --accent2:#8c5eff;        --accent2-r:140; --accent2-g:94; --accent2-b:255;
  }

  /* Per-mode palettes */
  body[data-mode="marina"]{
    --bg1:#1c1411; --bg2:#2a1916;
    --accent:#f6d36e; --accent-r:246; --accent-g:211; --accent-b:110;
    --accent2:#ff7690; --accent2-r:255; --accent2-g:118; --accent2-b:144;
  }
  body[data-mode="sigrid"]{
    --bg1:#0b1520; --bg2:#102133;
    --accent:#d9e2ed; --accent-r:217; --accent-g:226; --accent-b:237;
    --accent2:#6ea7ff; --accent2-r:110; --accent2-g:167; --accent2-b:255;
  }
  body[data-mode="clarity"]{
    --bg1:#0b1f24; --bg2:#141136;
    --accent:#08ffd7; --accent-r:8;  --accent-g:255; --accent-b:215;
    --accent2:#8c5eff; --accent2-r:140; --accent2-g:94; --accent2-b:255;
  }
  body[data-mode="illumina"]{
    --bg1:#130a21; --bg2:#1a0f2f;
    --accent:#bca0ff; --accent-r:188; --accent-g:160; --accent-b:255;
    --accent2:#4a257f; --accent2-r:74; --accent2-g:37; --accent2-b:127;
  }
  body[data-mode="kugelblitz"]{
    --bg1:#000a1f; --bg2:#000515;
    --accent:#eaf2ff; --accent-r:234; --accent-g:242; --accent-b:255;
    --accent2:#ffb84d; --accent2-r:255; --accent2-g:184; --accent2-b:77;
  }

  /* Base layout */
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    min-height:100vh;
    color:var(--text);
    background:
      radial-gradient(120rem 60rem at 70% -10%, var(--bg2) 0%, transparent 40%),
      radial-gradient(90rem 80rem at -10% 10%, var(--bg2) 0%, transparent 40%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    letter-spacing:.2px;
    overflow-x:hidden;
  }
  .wrap{
    max-width:1200px;
    margin-inline:auto;
    padding:clamp(12px,3vmin,28px);
    position:relative;
    z-index:2;
  }

  /* Header */
  header{ display:flex; align-items:center; gap:1rem; padding:clamp(10px,2vmin,20px) 0 .75rem; border-bottom:1px solid var(--soft); }
  .logo{
    width:44px; height:44px; flex:0 0 auto; border-radius:50%;
    display:grid; place-items:center;
    background:
      radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.18) 0 30%, rgba(0,0,0,0) 40%),
      conic-gradient(from 210deg, #ffefb0, #ffd867, #f6c64f, #f0b43b, #ffd867, #ffefb0);
    box-shadow: inset 0 0.18rem 0.35rem rgba(0,0,0,.28), 0 0.45rem 1.2rem rgba(0,0,0,.35);
    border:1px solid rgba(245,200,76,.6);
  }
  .logo svg{ width:62%; height:62%; filter: drop-shadow(0 2px 3px rgba(0,0,0,.4)); }
  header h1{ margin:0; line-height:1.1; font-weight:750; letter-spacing:.3px; font-size:clamp(1.06rem,2.2vw,1.48rem); }
  header h1 .sub{ opacity:.8; font-weight:600; display:block; font-size:.92em; }

  /* Controls */
  .controls{ display:flex; flex-wrap:wrap; align-items:center; gap:.6rem .6rem; padding: 1rem 0 1.1rem; }
  .btn{
    -webkit-tap-highlight-color: transparent;
    border:1px solid var(--ring);
    background: rgba(255,255,255,0.05);
    color:var(--text);
    padding:.62rem .95rem; border-radius:.75rem;
    cursor:pointer; user-select:none;
    font-weight:700; letter-spacing:.25px;
    box-shadow: 0 0.6rem 2rem rgba(0,0,0,.35), 0 0 0.6rem rgba(0,0,0,.35);
    transition: transform .08s ease, background .25s ease, opacity .25s ease, border-color .25s ease;
  }
  .btn:hover{ transform:translateY(-1px); background: rgba(255,255,255,0.08); }
  .btn:active{ transform:translateY(1px) scale(.99); }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }

  .seg{ display:flex; gap:0; border:1px solid var(--ring); border-radius:.8rem; overflow:hidden; box-shadow: 0 0.6rem 2rem rgba(0,0,0,.35); }
  .seg button{
    border:0; padding:.62rem .9rem; font-weight:800; letter-spacing:.2px; background:transparent; color:var(--text);
    cursor:pointer; position:relative; isolation:isolate; white-space:nowrap;
  }
  .seg button + button{ border-left:1px solid var(--ring); }
  .seg button.active{
    background: rgba(var(--accent-r), var(--accent-g), var(--accent-b), .16);
    box-shadow: inset 0 0 0 1px rgba(var(--accent-r), var(--accent-g), var(--accent-b), .38);
  }

  /* Panels */
  .panes{ display:grid; gap:1rem; grid-template-columns: 1fr; }
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,0));
    border:1px solid var(--soft);
    border-radius:1rem; padding:1rem; box-shadow: 0 0.6rem 2rem rgba(0,0,0,.35);
  }

  /* Guided Panel */
  .info{ display:grid; gap:.55rem; }
  .info .headline{ display:flex; flex-wrap:wrap; align-items:center; gap:.6rem; font-weight:800; }
  .pill{
    border:1px solid rgba(var(--accent-r), var(--accent-g), var(--accent-b), .4);
    background: rgba(var(--accent-r), var(--accent-g), var(--accent-b), .12);
    color:var(--text);
    padding:.28rem .55rem; border-radius:.55rem; font-size:.88rem; font-weight:800;
  }
  .equation{ opacity:.9; font-weight:700; }
  .visitor, .science, .poet{ color: var(--muted); line-height:1.55; }
  .label{ font-weight:800; color:var(--text); opacity:.9; }

  /* Bee Notes */
  .notes label{ display:block; font-weight:800; margin-bottom:.45rem; color: var(--muted); }
  textarea{
    width:100%; min-height: 28svh; resize: vertical;
    background: rgba(0,0,0,.22); color: var(--text);
    border:1px solid var(--soft); border-radius:.9rem;
    padding: .95rem 1rem; line-height:1.5; font-size:1rem; outline:none;
    box-shadow: 0 0.6rem 2rem rgba(0,0,0,.35);
  }
  textarea::placeholder{ color: rgba(199,196,214,.75); }

  /* Self-Check */
  .status{ display:grid; gap:.6rem; grid-template-columns: 1fr; }
  .status-item{
    display:flex; align-items:center; justify-content:space-between; gap:.8rem;
    background: rgba(0,0,0,.18); border:1px dashed var(--soft);
    border-radius:.75rem; padding:.6rem .75rem;
  }
  .status-item .label{ opacity:.9; font-weight:700; }
  .badge{
    font-weight:900; padding:.28rem .58rem; border-radius:.55rem; border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.35); letter-spacing:.35px; text-transform: lowercase;
  }
  .pass{ color:#7fffb0; border-color: rgba(127,255,176,.45); }
  .fail{ color:#ff7b7b; border-color: rgba(255,123,123,.45); }
  .idle{ color:#ffdf6b; border-color: rgba(255,223,107,.45); }

  /* Canvas overlay (visual modes) */
  #overlay{
    position:fixed; inset:0; width:100vw; height:100vh;
    pointer-events:none; z-index:1; opacity:1; transition: opacity .8s ease;
  }

  /* Manifest & Science Bridge */
  .manifest table{ width:100%; border-collapse:collapse; border:1px solid var(--soft); border-radius:.9rem; overflow:hidden; }
  .manifest th, .manifest td{ text-align:left; padding:.7rem .8rem; border-bottom:1px solid var(--soft); }
  .manifest th{ background: rgba(0,0,0,.28); position:sticky; top:0; }
  .manifest tr:last-child td{ border-bottom:0; }
  .muted{ color:var(--muted); }
  pre{ margin:.5rem 0; padding:.75rem; border-radius:.6rem; background: rgba(0,0,0,.25); border:1px solid var(--soft); overflow:auto; }

  /* Footer */
  footer{ margin-top: 1.2rem; padding: 1.2rem 0 .6rem; color: var(--muted); display:flex; align-items:center; gap:.7rem; justify-content:space-between; border-top: 1px solid var(--soft); font-weight:700; letter-spacing:.3px; }
  .malala-line{
    margin-top:.35rem; color:#88f2ff; opacity:.7; font-style:italic; letter-spacing:.2px; display:none;
  }
  body[data-mode="neutral"] .malala-line{ display:block; }

  /* Accessibility and motion preferences */
  @media (prefers-reduced-motion: reduce){
    #overlay{ transition:none; }
    .btn{ transition: none; }
  }
</style>
</head>
<body data-mode="neutral">
  <canvas id="overlay" aria-hidden="true"></canvas>

  <div class="wrap" role="application" aria-label="Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color">
    <header>
      <div class="logo" aria-hidden="true">
        <!-- sun / gold glyph -->
        <svg viewBox="0 0 100 100" fill="none" stroke="#603d00" stroke-width="6" aria-hidden="true">
          <circle cx="50" cy="50" r="26" fill="rgba(255,255,255,.25)" stroke="rgba(255,255,255,.4)"/>
          <g stroke-linecap="round">
            <line x1="50" y1="3"  x2="50" y2="19"/>
            <line x1="50" y1="81" x2="50" y2="97"/>
            <line x1="3"  y1="50" x2="19" y2="50"/>
            <line x1="81" y1="50" x2="97" y2="50"/>
            <line x1="17" y1="17" x2="28" y2="28"/>
            <line x1="72" y1="72" x2="83" y2="83"/>
            <line x1="17" y1="83" x2="28" y2="72"/>
            <line x1="72" y1="28" x2="83" y2="17"/>
          </g>
        </svg>
      </div>
      <h1>
        Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color
        <span class="sub">scientific √ó spiritual √ó sensual</span>
      </h1>
    </header>

    <section class="controls" aria-label="Controls">
      <button class="btn" id="unlockAudio" aria-pressed="false" title="Enable WebAudio (user gesture required)">üîä Unlock Audio</button>
      <button class="btn" id="runSelfCheck" title="Run oscillator, timer, and render checks">üß™ Run Self‚ÄëCheck</button>
      <div class="seg" role="tablist" aria-label="Mode toggles">
        <button role="tab" id="tab-marina"   data-mode="marina"   aria-selected="false" title="Marina ‚Äî empathy as time">Marina</button>
        <button role="tab" id="tab-sigrid"   data-mode="sigrid"   aria-selected="false" title="Sigrid ‚Äî clarity as emotion">Sigrid</button>
        <button role="tab" id="tab-clarity"  data-mode="clarity"  aria-selected="false" title="Clarity ‚Äî faith in motion">Clarity</button>
        <button role="tab" id="tab-illumina" data-mode="illumina" aria-selected="false" title="Illumina ‚Äî coherence as witness">Illumina</button>
        <button role="tab" id="tab-kugelblitz" data-mode="kugelblitz" aria-selected="false" title="Kugelblitz ‚Äî energy as desire">Kugelblitz</button>
      </div>
    </section>

    <div class="panes">
      <!-- Guided panel -->
      <section class="panel info" aria-live="polite" aria-label="Guided Mode Information">
        <div class="headline">
          <span class="pill" id="pillName">Welcome</span>
          <span class="equation" id="equation">Time √ó Energy √ó Feeling</span>
        </div>
        <p class="visitor" id="visitorNote">
          This is a gentle instrument. Begin in ‚Äúneutral‚Äù and choose a mode when ready. You are safe, oriented, and free to explore.
        </p>
        <p class="science" id="scienceNote">
          Physics and perception are treated as harmonics of one field. Modes shift cadence and color to help attention organize.
        </p>
        <p class="poet" id="poetNote">
          Write a few lines in Bee Notes as you listen. Start with temperature, then meaning. Let the page breathe before it burns.
        </p>
      </section>

      <!-- Bee Notes -->
      <section class="panel notes" aria-label="Bee Notes">
        <label for="bee">üêù Bee Notes ‚Ä¢ <span id="modeName">‚Äî</span></label>
        <textarea id="bee" placeholder="Select a mode above to begin writing. Notes save locally per mode." disabled></textarea>
      </section>

      <!-- Self-Check -->
      <section class="panel selfcheck" aria-label="Self-Check">
        <div class="status">
          <div class="status-item"><span class="label">Audio @ 128 Hz</span><span id="chk-audio" class="badge idle">idle</span></div>
          <div class="status-item"><span class="label">Timer drift &plusmn; 30 ms</span><span id="chk-timer" class="badge idle">idle</span></div>
          <div class="status-item"><span class="label">Render loss &lt; 2 frames</span><span id="chk-raf" class="badge idle">idle</span></div>
        </div>
      </section>

      <!-- Science Bridge -->
      <section class="panel" aria-label="Science Bridge">
        <h2 style="margin:.2rem 0 .6rem;font-size:1.05rem">Science Bridge ¬∑ symbols to sensation</h2>
        <pre><code>E = m c¬≤          energy‚Äìmatter equivalence
œÑ = E / c¬≥        time as energy moderated by the speed of light (interpretive bridge)
Œª = h / p         de Broglie wavelength (wave‚Äìparticle link)</code></pre>
        <ul class="muted" style="margin:.6rem 0 0.2rem; padding-left:1.1rem">
          <li>E = mc¬≤ ‚Üí ‚Äúlight slows to feel itself‚Äù</li>
          <li>œÑ = E / c¬≥ ‚Üí ‚Äúthe longer you see, the slower it burns‚Äù</li>
          <li>Œª = h / p ‚Üí ‚Äúevery action sings a note‚Äù</li>
        </ul>
        <p class="muted" style="margin:.4rem 0 0">
          Note: This does not replace physics; it invites feeling and measurement to inform each other.
        </p>
      </section>

      <!-- Manifest -->
      <section class="panel manifest" aria-label="Appendix ¬∑ Illumina Manifest">
        <h2 style="margin:.2rem 0 .6rem;font-size:1.05rem">Appendix ¬∑ Illumina Manifest</h2>
        <div class="muted" style="margin-bottom:.6rem">A lucid table of modes, equations, color/rhythm, and Bee keys.</div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Mode</th>
                <th>Equation</th>
                <th>Color ¬∑ Rhythm ¬∑ Overlay</th>
                <th>Bee Key</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Marina</td>
                <td>œÑ = E / c¬≥ ¬∑ œÜ</td>
                <td>gold clock (1.618 s) ‚Äî empathy as time</td>
                <td><code>bee.notes.marina</code></td>
              </tr>
              <tr>
                <td>Sigrid</td>
                <td>‚àö2 cadence (clarity)</td>
                <td>sky aurora (1.414 s) ‚Äî precision as emotion</td>
                <td><code>bee.notes.sigrid</code></td>
              </tr>
              <tr>
                <td>Clarity</td>
                <td>160 ‚Üî 432 Hz</td>
                <td>aqua‚Äëviolet jellyfish (~6 s) ‚Äî faith in motion</td>
                <td><code>bee.notes.clarity</code></td>
              </tr>
              <tr>
                <td>Illumina</td>
                <td>42‚Äëday cycle</td>
                <td>deep‚Äëpurple starfield (slow drift) ‚Äî collective witness</td>
                <td><code>bee.notes.illumina</code></td>
              </tr>
              <tr>
                <td>Kugelblitz</td>
                <td>E ‚Üí ‚àû</td>
                <td>blue‚Üíwhite‚Üígold‚Üíred‚Üíviolet (3 s) ‚Äî fusion heat‚Äëpulse</td>
                <td><code>bee.notes.kugelblitz</code></td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="muted" style="margin:.7rem 0 0">
          This table is your map. Equation shows the physics symbol; Color/Rhythm shows the feel; Bee Key is where your local note is saved. Your data never leaves your device. Next: pick a mode ‚Üí Unlock Audio ‚Üí Run Self‚ÄëCheck ‚Üí write one Bee Note.
        </p>
      </section>
    </div>

    <footer>
      <div>üêù page 42 ¬∑ eat the world</div>
      <div>2025 midnight release</div>
    </footer>
    <div class="malala-line" aria-label="Malala note">
      ‚Äúyou are not in control ‚Äî yet you are chosen. you doubt, you fight, you float.‚Äù
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  /* ==========================================================
     Illumina v4 ‚Äî Guided + Reliable
     - Canvas overlays per mode
     - Bee Notes per mode (localStorage)
     - WebAudio @128 Hz unlock
     - Self-Check: audio, timer drift, rAF loss
     - On full pass ‚Üí Kugelblitz heat-blast
     - No console logs; no network calls
     ========================================================== */

  /* ---------- Utilities ---------- */
  const TAU = Math.PI*2;
  const PHI = (1 + Math.sqrt(5)) / 2; // 1.618...
  const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));
  const lerp = (a,b,t)=> a + (b-a)*t;
  const easeOutCubic = t => 1 - Math.pow(1-t,3);

  function mixRGB(c1, c2, t){
    const a = [(c1>>16)&255, (c1>>8)&255, c1&255];
    const b = [(c2>>16)&255, (c2>>8)&255, c2&255];
    const r = lerp(a[0],b[0],t), g = lerp(a[1],b[1],t), bl = lerp(a[2],b[2],t);
    return `rgb(${r|0},${g|0},${bl|0})`;
  }

  /* ---------- DOM ---------- */
  const body = document.body;
  const canvas = document.getElementById('overlay');
  const ctx = canvas && canvas.getContext ? canvas.getContext('2d', { alpha:true }) : null;

  const bee = document.getElementById('bee');
  const modeNameEl = document.getElementById('modeName');
  const pillName = document.getElementById('pillName');
  const equationEl = document.getElementById('equation');
  const visitorEl = document.getElementById('visitorNote');
  const scienceEl = document.getElementById('scienceNote');
  const poetEl = document.getElementById('poetNote');

  const unlockBtn = document.getElementById('unlockAudio');
  const selfBtn = document.getElementById('runSelfCheck');

  const tabButtons = Array.from(document.querySelectorAll('.seg [role="tab"]"));

  /* ---------- Canvas sizing ---------- */
  let DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  function fit(){
    if (!canvas || !ctx) return;
    DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const w = Math.floor((window.innerWidth || document.documentElement.clientWidth) * DPR);
    const h = Math.floor((window.innerHeight || document.documentElement.clientHeight) * DPR);
    canvas.width = w; canvas.height = h;
    canvas.style.width = '100vw';
    canvas.style.height = '100vh';
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(DPR, DPR);
  }
  fit();
  window.addEventListener('resize', fit, { passive:true });

  /* ---------- Modes & Guided content ---------- */
  const MODES = {
    marina: {
      name: 'Marina',
      eq: 'œÑ = E / c¬≥ ¬∑ œÜ',
      visitor: 'you are safe here‚Ä¶ feeling measures distance.',
      science: 'Empathy ‚âà temporal resolution; attention slows perceived time (œÑ) as energy becomes coherent.',
      poet: 'Start with the body. Write the temperature before the meaning.',
      overlay: 'marina'
    },
    sigrid: {
      name: 'Sigrid',
      eq: 'ŒîE = clarity¬≤ (‚àö2)',
      visitor: 'clarity is kindness; you can think and still feel.',
      science: 'A square‚Äëroot cadence as a metaphor for discernment gains.',
      poet: 'Name one detail exactly. Clarity is a love language.',
      overlay: 'sigrid'
    },
    clarity: {
      name: 'Clarity',
      eq: '160 ‚Üî 432 Hz',
      visitor: 'breathe with the drift; you don‚Äôt need to control the current.',
      science: 'Breath entrainment shifts perceived duration; rhythm organizes attention.',
      poet: 'Let the sentence breathe. End lines where the inhale ends.',
      overlay: 'clarity'
    },
    illumina: {
      name: 'Illumina',
      eq: '42‚Äëday cycle',
      visitor: 'this is the collective field; your calm adds to it.',
      science: 'Periodic practice builds coherence; slow star drift as shared phase.',
      poet: 'Archive one truth per day. Bees make books.',
      overlay: 'illumina'
    },
    kugelblitz: {
      name: 'Kugelblitz',
      eq: 'E ‚Üí ‚àû',
      visitor: 'heat is not danger; it is presence. you are allowed to shine.',
      science: 'Metaphoric high energy density: awareness folding back on itself.',
      poet: 'Write the ignition point ‚Äî let heat be honest, not cruel.',
      overlay: 'kugelblitz'
    }
  };

  const ORDER = ['marina','sigrid','clarity','illumina','kugelblitz'];

  let mode = 'neutral';
  let prevMode = null;

  function beeKey(m){ return `bee.notes.${m}`; }

  function loadBee(m){
    if (!bee) return;
    if (m === 'neutral'){
      bee.value = '';
      bee.disabled = true;
      bee.placeholder = 'Select a mode above to begin writing. Notes save locally per mode.';
      modeNameEl && (modeNameEl.textContent = '‚Äî');
      return;
    }
    let v = '';
    try{ v = localStorage.getItem(beeKey(m)) || ''; }catch(e){}
    bee.disabled = false;
    bee.placeholder = `Write with heat. Saved locally as ${beeKey(m)}`;
    bee.value = v;
    modeNameEl && (modeNameEl.textContent = MODES[m].name);
  }

  function saveBee(){
    if (!bee || mode === 'neutral') return;
    try{ localStorage.setItem(beeKey(mode), bee.value || ''); }catch(e){}
  }
  bee && bee.addEventListener('input', saveBee);

  function setMode(m){
    if (!m || m === mode) return;
    prevMode = mode;
    mode = m;
    body && body.setAttribute('data-mode', m);

    // Tabs visual state
    tabButtons.forEach(b=>{
      const on = b.getAttribute('data-mode') === m;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });

    // Guided panel
    if (m !== 'neutral'){
      const M = MODES[m];
      pillName && (pillName.textContent = M.name);
      equationEl && (equationEl.textContent = M.eq);
      visitorEl && (visitorEl.textContent = M.visitor);
      scienceEl && (scienceEl.textContent = M.science);
      poetEl && (poetEl.textContent = M.poet);
    } else {
      pillName && (pillName.textContent = 'Welcome');
      equationEl && (equationEl.textContent = 'Time √ó Energy √ó Feeling');
      visitorEl && (visitorEl.textContent = 'This is a gentle instrument. Begin in ‚Äúneutral‚Äù and choose a mode when ready. You are safe, oriented, and free to explore.');
      scienceEl && (scienceEl.textContent = 'Physics and perception are treated as harmonics of one field. Modes shift cadence and color to help attention organize.');
      poetEl && (poetEl.textContent = 'Write a few lines in Bee Notes as you listen. Start with temperature, then meaning. Let the page breathe before it burns.');
    }

    // Kugelblitz overlay fade intent
    if (prevMode === 'kugelblitz' && mode !== 'kugelblitz') { kugelFadeTarget = 0; }
    else if (mode === 'kugelblitz') { kugelFade = 0; kugelFadeTarget = 1; }
    else { kugelFadeTarget = 1; }

    loadBee(m);
  }

  // Attach tab handlers (null-guarded)
  tabButtons.forEach(btn=>{
    btn && btn.addEventListener('click', ()=> setMode(btn.getAttribute('data-mode')));
  });

  // Start neutral
  setMode('neutral');

  /* ---------- Audio (unlock + 128 Hz) ---------- */
  let audioCtx = null;
  function markStatus(id, pass, msg){
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove('idle','pass','fail');
    el.classList.add(pass ? 'pass' : 'fail');
    el.textContent = (pass ? 'pass' : 'fail') + (msg ? ` ¬∑ ${msg}` : '');
  }

  unlockBtn && unlockBtn.addEventListener('click', async ()=>{
    try{
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) throw new Error('NoAudio');
      if (!audioCtx) audioCtx = new AC({ latencyHint:'interactive' });
      if (audioCtx.state === 'suspended' && audioCtx.resume) await audioCtx.resume();

      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.value = 128;
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.05, audioCtx.currentTime + 0.05);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.28);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.3);

      unlockBtn.textContent = '‚úÖ Audio Unlocked';
      unlockBtn.setAttribute('aria-pressed','true');
      unlockBtn.disabled = true;
      markStatus('chk-audio', true, 'unlocked');
    }catch(e){
      markStatus('chk-audio', false, 'unsupported');
    }
  });

  /* ---------- Self-Check ---------- */
  let blastMoment = 0; // >0 triggers heat-blast
  selfBtn && selfBtn.addEventListener('click', async ()=>{
    // set to running‚Ä¶
    ['chk-audio','chk-timer','chk-raf'].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('pass','fail'); el.classList.add('idle'); el.textContent = 'running‚Ä¶';
    });

    // 1) Audio @128 Hz
    let audioPass = false;
    try{
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) throw new Error('NoAudio');
      if (!audioCtx) audioCtx = new AC();
      if (audioCtx.state === 'suspended' && audioCtx.resume) await audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.frequency.value = 128; osc.type = 'sine';
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.035, audioCtx.currentTime + 0.04);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.28);
      audioPass = true;
    }catch(e){ audioPass = false; }
    markStatus('chk-audio', audioPass, '128 Hz');

    // 2) Timer drift ¬±30ms ‚Äî 20 intervals of 50ms
    const expected = 50;
    let maxAbsDrift = 0;
    let last = performance.now();
    for (let i=0;i<20;i++){
      await new Promise(r => setTimeout(r, expected));
      const now = performance.now();
      const drift = (now - last) - expected;
      if (Math.abs(drift) > maxAbsDrift) maxAbsDrift = Math.abs(drift);
      last = now;
    }
    const timerPass = maxAbsDrift <= 30;
    markStatus('chk-timer', timerPass, `${maxAbsDrift.toFixed(0)} ms`);

    // 3) rAF loss < 2 ‚Äî count frames >33ms during ~1s
    let longFrames = 0;
    let start = performance.now();
    let prev = start;
    await new Promise(res=>{
      function tick(t){
        const dt = t - prev; prev = t;
        if (dt > 33) longFrames++;
        if (t - start < 1000) requestAnimationFrame(tick); else res();
      }
      requestAnimationFrame(tick);
    });
    const rafPass = longFrames < 2;
    markStatus('chk-raf', rafPass, `loss ${longFrames}`);

    if (audioPass && timerPass && rafPass){
      blastMoment = performance.now();
      if (mode !== 'kugelblitz'){ kugelFade = 0; kugelFadeTarget = 1; setTimeout(()=>{ kugelFadeTarget = 0; }, 1200); }
    }
  });

  /* ---------- Visual Systems (Canvas 2D) ---------- */
  const reduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // MARINA: œÜ clock (1.618 s rotation)
  function drawMarina(t, alpha){
    if (!ctx || !canvas) return;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.18;

    ctx.save();
    ctx.globalAlpha = 0.9*alpha;
    ctx.translate(cx, cy);

    // Dial
    ctx.beginPath(); ctx.arc(0,0,r,0,TAU);
    ctx.strokeStyle = 'rgba(246,211,110,0.55)';
    ctx.lineWidth = 2; ctx.stroke();

    // œÜ marker
    ctx.font = '600 28px system-ui, sans-serif';
    ctx.textAlign = 'center'; ctx.textBaseline='middle';
    ctx.fillStyle = 'rgba(255,118,144,0.8)';
    ctx.fillText('œÜ', 0, -r*0.6);

    // Hands
    const period = 1618;
    const ang = (t % period) / period * TAU;
    const len1 = r*0.92, len2 = len1/PHI;

    ctx.rotate(ang);
    ctx.strokeStyle = 'rgba(246,211,110,0.95)';
    ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(len1,0); ctx.stroke();
    ctx.rotate(TAU/PHI);
    ctx.strokeStyle = 'rgba(255,118,144,0.85)';
    ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(len2,0); ctx.stroke();

    ctx.restore();
  }

  // SIGRID: ‚àö2 aurora (1.414 s pulse)
  function drawSigrid(t, alpha){
    if (!ctx || !canvas) return;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const period = 1414;
    const p = (t % period) / period;
    const pulse = 0.35 + 0.65 * Math.sin(p*TAU);

    ctx.save();
    ctx.globalAlpha = alpha * 0.9;
    const layers = reduced ? 3 : 6;
    for (let i=0;i<layers;i++){
      const y = h*0.22 + i*(h*0.06);
      const amp = 38 + i*12;
      const a = 0.08 + (i/layers)*0.12 + pulse*0.08;
      const grad = ctx.createLinearGradient(0,y, w,y);
      grad.addColorStop(0, `rgba(200,220,255,${a})`);
      grad.addColorStop(0.5, `rgba(110,167,255,${a*1.15})`);
      grad.addColorStop(1, `rgba(210,220,232,${a})`);
      ctx.fillStyle = grad;

      ctx.beginPath();
      ctx.moveTo(0,y);
      const step = reduced ? 40 : 24;
      for (let x=0; x<=w; x+=step){
        const curve = Math.sin((x/w)*TAU*(1 + 0.2*Math.sin(t*0.0003))) * amp * (0.7 + 0.3*Math.sin(t*0.0005 + i));
        ctx.lineTo(x, y + curve);
      }
      ctx.lineTo(w, y+amp*1.6);
      ctx.lineTo(0, y+amp*1.6);
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();
  }

  // CLARITY: jellyfish (~6 s)
  const jellies = [];
  function ensureJellies(){
    const want = reduced ? 6 : 12;
    while (jellies.length < want){
      jellies.push({ x:Math.random(), y:Math.random(), r: lerp(28,76,Math.random()), phase: Math.random()*TAU });
    }
  }
  ensureJellies();

  function drawClarity(t, alpha){
    if (!ctx || !canvas) return;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const breath = 0.55 + 0.45 * Math.sin(((t%6000)/6000)*TAU);

    ctx.save();
    ctx.globalAlpha = alpha * 0.88;

    jellies.forEach(j=>{
      const driftX = Math.sin(t*0.0002 + j.phase)*0.004;
      const driftY = -0.015;
      j.x = (j.x + driftX + 1) % 1;
      j.y = (j.y + driftY + 1) % 1;

      const x = j.x * w, y = j.y * h;
      const r = j.r * (0.8 + 0.35*breath);

      const bell = ctx.createRadialGradient(x,y,r*0.1, x,y,r);
      bell.addColorStop(0, 'rgba(8,255,215,0.55)');
      bell.addColorStop(0.5, 'rgba(140,94,255,0.35)');
      bell.addColorStop(1, 'rgba(140,94,255,0.0)');
      ctx.fillStyle = bell;
      ctx.beginPath(); ctx.arc(x,y,r,0,TAU); ctx.fill();

      if (!reduced){
        ctx.lineWidth = 1.2;
        for (let k=0;k<6;k++){
          const ang = (k/6)*TAU + j.phase*0.2 + t*0.0004;
          const len = r * (0.9 + 0.2*Math.sin(t*0.001 + k));
          const x2 = x + Math.cos(ang)*len*0.6;
          const y2 = y + Math.sin(ang)*len*1.2;
          ctx.strokeStyle = 'rgba(8,255,215,0.18)';
          ctx.beginPath(); ctx.moveTo(x, y + r*0.2); ctx.quadraticCurveTo(x, y2, x2, y2); ctx.stroke();
        }
      }
    });

    ctx.restore();
  }

  // ILLUMINA: starfield (42-day color sway)
  const stars = [];
  function initStars(){
    if (!canvas) return;
    stars.length = 0;
    const density = reduced ? 14000 : 9000;
    const count = Math.ceil((canvas.clientWidth * canvas.clientHeight) / density);
    for (let i=0;i<count;i++){
      stars.push({ x:Math.random(), y:Math.random(), r: Math.random()*1.6+0.2, sp: 0.6+Math.random()*1.2, tw: Math.random()*TAU });
    }
  }
  initStars();
  window.addEventListener('resize', initStars, { passive:true });

  function drawIllumina(t, alpha){
    if (!ctx || !canvas) return;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const days = Date.now() / 86400000;
    const cyc = (days % 42) / 42; // 0..1
    const hueMod = Math.sin(cyc*TAU)*0.15 + 0.85;

    ctx.save(); ctx.globalAlpha = 0.9*alpha;

    for (let i=0;i<stars.length;i++){
      const s = stars[i];
      const x = s.x*w, y = s.y*h;
      const tw = 0.5 + 0.5*Math.sin(t*0.0015*s.sp + s.tw);
      const a = 0.25 + tw*0.6;
      const r = (s.r + tw*0.8);

      const g = ctx.createRadialGradient(x,y,0.1, x,y,r*2.4);
      g.addColorStop(0, `rgba(${(180*hueMod)|0}, ${(150*hueMod)|0}, 255, ${a})`);
      g.addColorStop(1, `rgba(255,255,255,0)`);
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(x,y,r*2,0,TAU); ctx.fill();
    }

    // coherence ring
    ctx.globalAlpha = alpha * 0.18;
    const cx = w/2, cy = h/2, R = Math.min(w,h)*0.28;
    ctx.beginPath(); ctx.arc(cx, cy, R + Math.sin(t*0.001)*6, 0, TAU);
    ctx.strokeStyle = 'rgba(188,160,255,0.6)';
    ctx.lineWidth = 1.2; ctx.stroke();

    ctx.restore();
  }

  // KUGELBLITZ ‚Äî central pulse (3 s): blue ‚Üí white ‚Üí gold ‚Üí red heat ‚Üí violet
  function gradientColor(phase){
    if (phase < 0.2) return {from:0x0c4cff, to:0x3da1ff};          // blue
    if (phase < 0.4) return {from:0xffffff, to:0xf8f8ff};          // white
    if (phase < 0.6) return {from:0xf5c84c, to:0xffd76f};          // gold
    if (phase < 0.8) return {from:0xff3a24, to:0xff7f5c};          // red heat
    return {from:0x8c5eff, to:0xb79aff};                           // violet
  }

  function drawKugelblitz(t, alpha, extraBlast){
    if (!ctx || !canvas) return;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const cx = w/2, cy = h/2;
    const period = 3000;
    const ph = (t % period) / period;

    const swell = easeOutCubic((Math.sin(ph*TAU - Math.PI/2) + 1)/2);
    const baseR = Math.min(w,h) * (0.1 + 0.35*swell + 0.25*(extraBlast||0));

    ctx.save(); ctx.globalAlpha = alpha * (0.85 + 0.15*swell);

    const rings = reduced ? 4 : 6;
    for (let k=0;k<rings;k++){
      const p = ((ph + k*0.12) % 1 + 1) % 1;
      const {from,to} = gradientColor(p);
      const r1 = baseR + k * 40 * (1 + 0.6*swell);
      const r2 = r1 + 90 + 35*Math.sin(t*0.003 + k);

      const g = ctx.createRadialGradient(cx,cy,r1*0.1, cx,cy,r2);
      g.addColorStop(0, mixRGB(from,to,0.25));
      g.addColorStop(0.6, mixRGB(from,to,1.0));
      g.addColorStop(1, 'rgba(0,0,0,0)');

      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(cx,cy,r2,0,TAU); ctx.fill();
    }

    // white-hot core
    const coreR = baseR * (0.3 + 0.6*swell);
    const core = ctx.createRadialGradient(cx,cy,0, cx,cy,coreR);
    core.addColorStop(0, 'rgba(255,255,255,0.95)');
    core.addColorStop(1, 'rgba(255,255,255,0.0)');
    ctx.fillStyle = core;
    ctx.beginPath(); ctx.arc(cx,cy,coreR,0,TAU); ctx.fill();

    ctx.restore();
  }

  /* ---------- Heat-blast (after self-check pass) ---------- */
  function blastFactor(now){
    if (blastMoment <= 0) return 0;
    const t = now - blastMoment;
    if (t > 1600){ blastMoment = 0; return 0; }
    return easeOutCubic(clamp(t/1200, 0, 1));
  }

  /* ---------- Render loop ---------- */
  let kugelFade = 1, kugelFadeTarget = 1;
  let last = performance.now();

  function frame(now){
    if (!ctx || !canvas) { requestAnimationFrame(frame); return; }

    const dt = now - last; last = now;
    kugelFade += (kugelFadeTarget - kugelFade) * clamp(dt/220, 0, 1);
    if (Math.abs(kugelFade - kugelFadeTarget) < 0.002) kugelFade = kugelFadeTarget;

    ctx.clearRect(0,0, canvas.clientWidth, canvas.clientHeight);

    if (mode === 'marina')      drawMarina(now, 1.0);
    else if (mode === 'sigrid') drawSigrid(now, 1.0);
    else if (mode === 'clarity')drawClarity(now, 1.0);
    else if (mode === 'illumina')drawIllumina(now, 1.0);
    else if (mode === 'kugelblitz') drawKugelblitz(now, kugelFade, 0);

    // Gentle persistence after leaving Kugelblitz
    if (prevMode === 'kugelblitz' && mode !== 'kugelblitz' && kugelFade > 0.01){
      drawKugelblitz(now, kugelFade*0.7, 0);
    }

    // Heat-blast overlay when self-check passes
    const K = blastFactor(now);
    if (K > 0.001) drawKugelblitz(now, 0.85, K*1.1);

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  /* ---------- Keyboard navigation ---------- */
  window.addEventListener('keydown', e=>{
    if (e.altKey || e.metaKey || e.ctrlKey) return;
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft'){
      let i = ORDER.indexOf(mode);
      if (i < 0) i = 0; // from neutral to first mode
      const n = e.key === 'ArrowRight' ? (i+1)%ORDER.length : (i-1+ORDER.length)%ORDER.length;
      setMode(ORDER[n]);
    }
  }, { passive:true });

});
</script>
</body>
</html>
