<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Time ¬∑ Illumina v5 ‚Äî Gravity of Knowing</title>
<meta name="theme-color" content="#0a0b12" />
<style>
  :root{
    --bg-0:#080910;
    --bg-1:#0e1020;
    --glass:rgba(255,255,255,0.06);
    --stroke:rgba(255,255,255,0.14);
    --fg:#eef2ff;
    --muted:#aab0c7;
    --accent:#77bdf0; /* cool default (160 Hz) */
    --accent-weak:rgba(119,189,240,0.35);
    --chip-ok:#1dd1a1;
    --chip-bad:#ff6b6b;
    --ring:#2b2f4a;
    --focus:#ffffff;
  }
  /* Themes by tone */
  :root[data-theme="warm"]{ --accent:#ffb86c; --accent-weak:rgba(255,184,108,0.35); }
  :root[data-theme="cool"]{ --accent:#77bdf0; --accent-weak:rgba(119,189,240,0.35); }
  :root[data-theme="violet"]{ --accent:#c084fc; --accent-weak:rgba(192,132,252,0.35); }

  html,body{height:100%;background: radial-gradient(1200px 800px at 50% 40%, #14172a 0%, var(--bg-1) 55%, var(--bg-0) 100%); color:var(--fg); margin:0;}
  body{
    display:grid; grid-template-rows:auto 1fr auto;
    font-family: ui-monospace, "SFMono-Regular", Menlo, Consolas, "Liberation Mono", "DejaVu Sans Mono", Georgia, "Times New Roman", serif;
    letter-spacing:0.2px;
  }
  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:14px 18px; position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(8,9,16,0.9), rgba(8,9,16,0.6));
    border-bottom:1px solid var(--stroke); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
  }
  h1{
    font-weight:600; font-size: clamp(18px, 2.2vw, 22px); margin:0; letter-spacing:0.3px;
    background:linear-gradient(90deg, var(--accent), #a0aec0); -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  header .chips{display:flex; gap:8px; flex-wrap:wrap;}
  .chip{
    display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 8px; border-radius:999px;
    border:1px solid var(--stroke); background:var(--glass); user-select:none;
  }
  .chip.ok{ border-color:rgba(29,209,161,0.35); color:#caffea;}
  .chip.bad{ border-color:rgba(255,107,107,0.35); color:#ffd6d6;}
  .chip .dot{width:8px; height:8px; border-radius:50%;}
  .chip.ok .dot{background:var(--chip-ok);} .chip.bad .dot{background:var(--chip-bad);}
  .chip.hint{opacity:0.85}

  main{
    display:grid; grid-template-columns: minmax(280px, 380px) 1fr; gap:18px; padding:14px 18px 8px 18px; min-height:0;
  }

  /* Controls panel */
  .panel{
    border:1px solid var(--stroke); background:
      linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)),
      var(--glass);
    border-radius:14px; padding:14px; -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px);
    display:flex; flex-direction:column; gap:14px; min-height:0;
  }
  .panel h2{font-size:13px; text-transform:uppercase; letter-spacing:1px; margin:0 0 6px 0; color:#cfd6ea;}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end;}
  .row .col{display:flex; flex-direction:column; gap:6px;}
  label{font-size:12px; color:var(--muted);}

  input[type="range"]{
    -webkit-appearance:none; width:100%; height:28px; background:transparent;
  }
  input[type="range"]::-webkit-slider-runnable-track{
    height:6px; background:linear-gradient(90deg, var(--accent-weak), rgba(255,255,255,0.12));
    border-radius:999px; border:1px solid var(--stroke);
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; margin-top:-6px; width:18px; height:18px; border-radius:50%;
    background: var(--accent); border:2px solid #00000022; box-shadow:0 1px 0 #ffffff20 inset, 0 4px 14px rgba(0,0,0,0.25);
  }
  input[type="range"]::-moz-range-track{height:6px; background:linear-gradient(90deg, var(--accent-weak), rgba(255,255,255,0.12)); border-radius:999px; border:1px solid var(--stroke);}
  input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--accent);border:2px solid #00000022;}
  input[type="number"], input[type="text"]{
    width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--stroke); background:rgba(0,0,0,0.25); color:var(--fg);
  }
  input[type="number"]:focus, input[type="text"]:focus, select:focus, button:focus, a:focus{
    outline:2px solid var(--focus); outline-offset:2px;
  }
  fieldset{border:1px dashed var(--stroke); border-radius:12px; padding:10px; margin:0;}
  legend{font-size:12px; color:#cfd6ea; padding:0 6px;}
  .modes{display:grid; grid-template-columns:1fr; gap:10px;}
  .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .tone-buttons button{
    border:1px solid var(--stroke); background:var(--glass); color:var(--fg); padding:8px 10px; border-radius:12px; cursor:pointer;
    transition:transform 120ms ease, background 160ms ease;
  }
  .tone-buttons button[aria-pressed="true"]{ background:linear-gradient(180deg, var(--accent-weak), rgba(255,255,255,0.03)); }
  .tone-buttons button:active{ transform:scale(0.98); }
  .btn{
    border:1px solid var(--stroke); background:var(--glass); color:var(--fg); padding:10px 12px; border-radius:12px; cursor:pointer;
    transition:transform 120ms ease, background 160ms ease; font-weight:600;
  }
  .btn.primary{ background: radial-gradient(120px 60px at 50% 0%, var(--accent-weak), rgba(255,255,255,0.03)); }
  .btn:active{ transform:scale(0.98); }
  .btn-group{display:flex; gap:8px; flex-wrap:wrap;}

  /* Canvas area */
  .stage{
    position:relative; border:1px solid var(--stroke); border-radius:14px; overflow:hidden; min-height:280px;
    background: radial-gradient(900px 600px at 50% 40%, rgba(255,255,255,0.04), rgba(255,255,255,0.02) 40%, rgba(0,0,0,0) 60%);
  }
  canvas{display:block; width:100%; height:100%;}
  /* Readout overlay */
  .readout{
    position:absolute; left:12px; top:12px; background:var(--glass); border:1px solid var(--stroke); border-radius:12px; padding:10px;
    -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); min-width:250px;
  }
  .read-grid{display:grid; grid-template-columns:auto 1fr; gap:4px 8px; font-size:12px;}
  .read-grid .key{color:#cfd6ea;}
  .read-grid .val{font-variant-numeric: tabular-nums lining-nums; text-align:right;}
  .examples-chip{position:absolute; right:12px; top:12px;}

  /* Bottom orbit row */
  footer{
    position:relative; display:flex; flex-direction:column; gap:10px; padding:14px 18px 18px 18px;
    border-top:1px solid var(--stroke); background:linear-gradient(180deg, rgba(8,9,16,0.6), rgba(8,9,16,0.9));
    -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
  }
  .rings{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;}
  .ring{
    width:34px; height:34px; border-radius:50%; display:grid; place-items:center;
    border:1px solid var(--stroke); background:radial-gradient(closest-side, rgba(255,255,255,0.06), rgba(255,255,255,0.01));
    color:#cfd6ea; font-size:12px; position:relative; overflow:hidden;
  }
  .ring::after{
    content:""; position:absolute; inset:-30%; border-radius:50%; border:1px dashed rgba(255,255,255,0.08);
    animation:spin 20s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .ctas{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; position:relative;}
  .cta{
    border:1px solid var(--stroke); background:var(--glass); padding:10px 12px; border-radius:999px; text-decoration:none; color:var(--fg);
    display:inline-flex; align-items:center; gap:8px; position:relative; overflow:hidden;
  }
  .cta::before{
    content:""; position:absolute; inset:-40%; border-radius:50%;
    background: radial-gradient(120px 60px at 20% 20%, var(--accent-weak), transparent 60%);
    animation: drift 9s ease-in-out infinite alternate;
  }
  .cta span{position:relative; z-index:1;}
  @keyframes drift{
    from{transform:translateX(-6px) translateY(-4px) rotate(-4deg);}
    to{transform:translateX(6px) translateY(4px) rotate(4deg);}
  }

  /* Diagnostics overlay */
  .diag{
    position:fixed; right:12px; bottom:12px; z-index:30;
    display:flex; gap:6px; flex-wrap:wrap; max-width:min(480px, 90vw);
  }

  /* Accessibility helpers */
  .sr{position:absolute !important; left:-9999px !important; top:auto !important; width:1px !important; height:1px !important; overflow:hidden !important;}
  :focus-visible{outline:2px solid var(--focus); outline-offset:2px;}
  @media (prefers-reduced-motion: reduce){
    *{animation-duration: 0.001s !important; animation-iteration-count: 1 !important;}
  }
</style>
</head>
<body>
  <header>
    <h1 aria-label="Title">Time ¬∑ Illumina v5 ‚Äî Gravity of Knowing</h1>
    <div class="chips" aria-live="polite">
      <div id="audioChip" class="chip"><span class="dot" aria-hidden="true"></span>Audio</div>
      <div id="fpsChip" class="chip"><span class="dot" aria-hidden="true"></span>Canvas ‚â• 30 fps</div>
      <div id="tauChip" class="chip"><span class="dot" aria-hidden="true"></span>œÑ updating</div>
      <div id="lsChip" class="chip"><span class="dot" aria-hidden="true"></span>localStorage</div>
    </div>
  </header>

  <main>
    <!-- Controls -->
    <aside class="panel" id="controls" aria-labelledby="controls-title">
      <h2 id="controls-title">Controls</h2>

      <fieldset aria-labelledby="mode-legend">
        <legend id="mode-legend">Energy Mode</legend>
        <div class="modes" role="radiogroup" aria-label="Energy mode">
          <div class="row">
            <div class="col">
              <label for="mode">Select</label>
              <select id="mode" aria-label="Energy mode select">
                <option value="photon">Photon (E = h¬∑ŒΩ)</option>
                <option value="rest">Rest Mass (E = m¬∑c¬≤)</option>
                <option value="rel">Relativistic Kinetic</option>
              </select>
            </div>
            <div class="col">
              <label for="Lref">Calibration K = L<sub>ref</sub>/M<sub>ref</sub></label>
              <div class="inline" role="group" aria-label="Calibration reference">
                <input id="Lref" type="number" min="1e-12" step="0.01" value="1" aria-label="L ref (meters)" />
                <input id="Mref" type="number" min="1e-12" step="0.01" value="1" aria-label="M ref (kilograms)" />
              </div>
            </div>
          </div>

          <!-- Photon -->
          <div id="photonControls" class="row" role="group" aria-label="Photon controls">
            <div class="col">
              <label for="nu">Frequency ŒΩ (log): <span id="nuLabel">‚Äî</span></label>
              <input id="nu" type="range" min="0" max="1000" step="1" value="775" />
              <div class="inline" aria-hidden="true" style="justify-content:space-between;font-size:11px;color:var(--muted);">
                <span>20 Hz</span><span>1e20 Hz</span>
              </div>
            </div>
            <div class="col">
              <label>Wavelength Œª</label>
              <div id="lambda" aria-live="polite">‚Äî</div>
            </div>
          </div>

          <!-- Rest mass -->
          <div id="restControls" class="row" role="group" aria-label="Rest mass controls" hidden>
            <div class="col">
              <label for="m0">Mass m (log): <span id="m0Label">‚Äî</span></label>
              <input id="m0" type="range" min="0" max="1000" step="1" value="900" />
              <div class="inline" aria-hidden="true" style="justify-content:space-between;font-size:11px;color:var(--muted);">
                <span>1e-9 kg</span><span>10 kg</span>
              </div>
            </div>
            <div class="col" aria-hidden="true"></div>
          </div>

          <!-- Relativistic -->
          <div id="relControls" class="row" role="group" aria-label="Relativistic kinetic controls" hidden>
            <div class="col">
              <label for="mr">Mass m (log): <span id="mrLabel">‚Äî</span></label>
              <input id="mr" type="range" min="0" max="1000" step="1" value="900" />
              <div class="inline" aria-hidden="true" style="justify-content:space-between;font-size:11px;color:var(--muted);">
                <span>1e-9 kg</span><span>10 kg</span>
              </div>
            </div>
            <div class="col">
              <label for="beta">Speed v / c: <span id="betaLabel">‚Äî</span></label>
              <input id="beta" type="range" min="0" max="0.99" step="0.001" value="0.9" />
              <div class="inline" aria-hidden="true" style="justify-content:space-between;font-size:11px;color:var(--muted);">
                <span>0</span><span>0.99c</span>
              </div>
            </div>
          </div>
        </div>
      </fieldset>

      <fieldset aria-labelledby="audio-legend">
        <legend id="audio-legend">Audio</legend>
        <div class="inline tone-buttons" role="group" aria-label="Tone mode">
          <button class="tone btn" data-tone="128" aria-pressed="false" aria-label="Tone 128 Hz (warm)">128 Hz üêù</button>
          <button class="tone btn" data-tone="160" aria-pressed="true" aria-label="Tone 160 Hz (cool)">160 Hz üíé</button>
          <button class="tone btn" data-tone="432" aria-pressed="false" aria-label="Tone 432 Hz (violet)">432 Hz üåô</button>
        </div>
        <div class="row" role="group" aria-label="Audio control sliders">
          <div class="col">
            <label for="volume">Volume</label>
            <input id="volume" type="range" min="0" max="1" step="0.001" value="0.25" />
          </div>
          <div class="col">
            <label for="alpha">Pitch Œ±</label>
            <input id="alpha" type="range" min="0.05" max="0.5" step="0.01" value="0.2" />
          </div>
        </div>
        <div class="inline">
          <button id="audioToggle" class="btn primary" aria-pressed="false" aria-label="Toggle audio">Play</button>
          <span id="audioStatus" aria-live="polite" style="font-size:12px;color:var(--muted)">Tap/click to unlock on iOS/Safari.</span>
        </div>
      </fieldset>

      <fieldset aria-labelledby="storage-legend">
        <legend id="storage-legend">Session</legend>
        <div class="row">
          <div class="col">
            <label>œÑ Created (cumulative)</label>
            <div id="tauTotal" aria-live="polite">‚Äî</div>
          </div>
          <div class="col">
            <label>Visits</label>
            <div id="visits" aria-live="polite">‚Äî</div>
          </div>
        </div>
        <div class="btn-group">
          <button id="save" class="btn" aria-label="Save snapshot JSON">Save Snapshot (JSON)</button>
          <button id="reset" class="btn" aria-label="Reset local storage">Reset</button>
        </div>
      </fieldset>

      <section aria-labelledby="keys-title">
        <h2 id="keys-title">Shortcuts</h2>
        <div style="font-size:12px;color:var(--muted);line-height:1.5">
          <span>p: Play/Pause ‚Ä¢ t: Tone ‚Ä¢ m: Mode ‚Ä¢ s: Save ‚Ä¢ r: Reset</span>
        </div>
      </section>
    </aside>

    <!-- Canvas + readout -->
    <section class="stage" aria-label="Simulation canvas">
      <canvas id="cv" aria-hidden="true"></canvas>
      <div class="readout" role="status" aria-live="polite">
        <div class="read-grid">
          <div class="key">Mode</div><div class="val" id="modeVal">‚Äî</div>
          <div class="key">K = L<sub>ref</sub>/M<sub>ref</sub></div><div class="val" id="kVal">‚Äî</div>

          <div class="key">ŒΩ</div><div class="val" id="nuVal">‚Äî</div>
          <div class="key">Œª</div><div class="val" id="lambdaVal">‚Äî</div>

          <div class="key">m</div><div class="val" id="mVal">‚Äî</div>
          <div class="key">v / c</div><div class="val" id="bVal">‚Äî</div>
          <div class="key">Œ≥</div><div class="val" id="gammaVal">‚Äî</div>

          <div class="key">E</div><div class="val" id="EVal">‚Äî</div>
          <div class="key">E (eV)</div><div class="val" id="EeVVal">‚Äî</div>
          <div class="key">œÑ_eff</div><div class="val" id="tauVal">‚Äî</div>
        </div>
      </div>
      <div id="examplesChip" class="chip examples-chip"><span class="dot" aria-hidden="true"></span>Examples OK</div>
    </section>
  </main>

  <footer>
    <div class="rings" role="list" aria-label="Illumina rings">
      <div class="ring" role="listitem" aria-label="Ring 1">1</div>
      <div class="ring" role="listitem" aria-label="Ring 2">2</div>
      <div class="ring" role="listitem" aria-label="Ring 3">3</div>
      <div class="ring" role="listitem" aria-label="Ring 4">4</div>
      <div class="ring" role="listitem" aria-label="Ring 5">5</div>
      <div class="ring" role="listitem" aria-label="Ring 6">6</div>
      <div class="ring" role="listitem" aria-label="Ring 7">7</div>
    </div>
    <div class="ctas" aria-label="Calls to action">
      <a class="cta" href="#" role="link" aria-label="MirrorHoney"><span>üåï MirrorHoney</span></a>
      <a class="cta" href="#" role="link" aria-label="Froot"><span>üçé Froot</span></a>
      <a class="cta" href="#" role="link" aria-label="School"><span>üè´ School</span></a>
      <a class="cta" href="#" role="link" aria-label="Jar"><span>üåø Jar</span></a>
    </div>
  </footer>

  <!-- Diagnostics overlay (tiny) -->
  <div class="diag" aria-live="polite">
    <div id="diagAudio" class="chip hint">‚úÖ Audio active</div>
    <div id="diagFPS" class="chip hint">‚úÖ Canvas ‚â• 30 fps</div>
    <div id="diagTau" class="chip hint">‚úÖ œÑ_eff updating</div>
    <div id="diagLS" class="chip hint">‚úÖ localStorage working</div>
  </div>

<script>
(function(){
  /* ======= CONSTANTS (SI) ======= */
  const C = Object.freeze({
    c: 299792458,                      // m/s
    h: 6.62607015e-34,                 // J¬∑s
    e: 1.602176634e-19,                // C
    G: 6.67430e-11                     // m^3¬∑kg^-1¬∑s^-2
  });
  const HBAR = C.h/(2*Math.PI);
  const T_PLANCK = Math.sqrt(HBAR*C.G/Math.pow(C.c,5));

  /* ======= STATE ======= */
  const state = {
    mode: 'photon',
    photon: { slider: 775 }, // defaults near 500 THz
    rest: { slider: 900 },
    rel: { mSlider: 900, beta: 0.9 },
    calib: { L: 1, M: 1 },   // K = L/M
    E: 0,
    EeV: 0,
    tau: 0,
    lambda: 0,
    gamma: 1,
    reduced: window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches,
    audio: {
      ctx: null, osc: null, gain: null, base: 160, alpha: 0.2,
      on: false, unlocked: false, vol: 0.25, theme: 'cool'
    },
    time: { last: performance.now(), acc: 0, fps: 60 },
    ls: { ok: true, visits: 0, tau_total: 0, last_mode: 'photon', toneHz: 160, calibration:{Lref:1,Mref:1} },
    diag: { audio:false, fps:false, tau:false, ls:false },
    examplesOK: false
  };

  /* ======= DOM ======= */
  const $ = sel => document.querySelector(sel);
  const cv = $('#cv'), ctx = cv.getContext('2d', { alpha:true });
  const modeSel = $('#mode');

  const photonControls = $('#photonControls');
  const restControls = $('#restControls');
  const relControls = $('#relControls');

  const Lref = $('#Lref'), Mref = $('#Mref');
  const nu = $('#nu'), nuLabel = $('#nuLabel'), lambdaOut = $('#lambda');

  const m0 = $('#m0'), m0Label = $('#m0Label');
  const mr = $('#mr'), mrLabel = $('#mrLabel'), beta = $('#beta'), betaLabel = $('#betaLabel');

  const audioToggle = $('#audioToggle'), volume = $('#volume'), alpha = $('#alpha');
  const toneButtons = Array.from(document.querySelectorAll('.tone'));
  const audioStatus = $('#audioStatus');

  const tauTotal = $('#tauTotal'), visits = $('#visits');

  const saveBtn = $('#save'), resetBtn = $('#reset');

  const modeVal = $('#modeVal'), kVal = $('#kVal'),
        nuVal = $('#nuVal'), lambdaVal = $('#lambdaVal'),
        mVal = $('#mVal'), bVal = $('#bVal'), gammaVal = $('#gammaVal'),
        EVal = $('#EVal'), EeVVal = $('#EeVVal'), tauVal = $('#tauVal');

  const examplesChip = $('#examplesChip');

  const audioChip = $('#audioChip'), fpsChip = $('#fpsChip'), tauChip = $('#tauChip'), lsChip = $('#lsChip');
  const diagAudio = $('#diagAudio'), diagFPS = $('#diagFPS'), diagTau = $('#diagTau'), diagLS = $('#diagLS');

  /* ======= UTILS ======= */
  const clamp = (x,a,b)=>Math.min(b,Math.max(a,x));
  const lerp = (a,b,t)=>a+(b-a)*t;
  const invLerp = (a,b,x)=> (x-a)/(b-a);
  const mapLog = (t, lo, hi)=> Math.pow(10, Math.log10(lo) + (Math.log10(hi)-Math.log10(lo))*t);
  const unmapLog = (x, lo, hi)=> invLerp(Math.log10(lo), Math.log10(hi), Math.log10(x));
  const fmtSI = (v, unit, sig=4) => {
    if(!isFinite(v) || v===0) return `0 ${unit||''}`.trim();
    const abs = Math.abs(v);
    const prefixes = [
      {p:1e-24,s:'y'}, {p:1e-21,s:'z'},{p:1e-18,s:'a'},{p:1e-15,s:'f'},{p:1e-12,s:'p'},
      {p:1e-9,s:'n'},{p:1e-6,s:'Œº'},{p:1e-3,s:'m'},{p:1,s:''},{p:1e3,s:'k'},
      {p:1e6,s:'M'},{p:1e9,s:'G'},{p:1e12,s:'T'},{p:1e15,s:'P'},{p:1e18,s:'E'},{p:1e21,s:'Z'},{p:1e24,s:'Y'}
    ];
    let pick = prefixes[8];
    for(const pr of prefixes){ if(abs>=pr.p) pick = pr; }
    const val = (v/pick.p);
    return `${Number(val.toPrecision(sig))} ${pick.s}${unit||''}`.trim();
  };
  const fmtTimeAdaptive = t=>{
    if(t < 1e-42) return `${t.toExponential(2)} s`;
    if(t < 1e-6) return fmtSI(t,'s',3);
    return fmtSI(t,'s',4);
  };
  const setChip = (el, ok, hintOK, hintBad)=>{
    el.classList.toggle('ok', ok);
    el.classList.toggle('bad', !ok);
    const dot = el.querySelector('.dot');
    if(!dot){ /* diagnostics chips have no dot */ el.textContent = ok? `‚úÖ ${hintOK}` : `‚ùå ${hintBad}`; }
    else el.setAttribute('title', ok? hintOK : hintBad);
  };

  /* ======= LOCAL STORAGE ======= */
  function loadLS(){
    try{
      const raw = localStorage.getItem('time_log');
      if(raw){
        state.ls = JSON.parse(raw);
      }else{
        state.ls = { visits:0, tau_total:0, last_mode:'photon', toneHz:160, calibration:{Lref:1, Mref:1} };
      }
      state.ls.visits += 1;
      state.diag.ls = true;
      saveLS();
    }catch(_e){
      state.ls = { visits:0, tau_total:0, last_mode:'photon', toneHz:160, calibration:{Lref:1, Mref:1} };
      state.diag.ls = false;
    }
    visits.textContent = String(state.ls.visits);
    tauTotal.textContent = fmtTimeAdaptive(state.ls.tau_total);
    // Apply persisted
    Lref.value = state.ls.calibration?.Lref ?? 1;
    Mref.value = state.ls.calibration?.Mref ?? 1;
    state.audio.base = state.ls.toneHz || 160;
    setToneTheme(state.audio.base);
    toneButtons.forEach(b=>b.setAttribute('aria-pressed', String(Number(b.dataset.tone)===state.audio.base)));
    modeSel.value = state.ls.last_mode || 'photon';
    switchMode(modeSel.value);
  }
  function saveLS(){
    try{
      state.ls.calibration = { Lref: Number(Lref.value), Mref: Number(Mref.value) };
      state.ls.last_mode = state.mode;
      state.ls.toneHz = state.audio.base;
      localStorage.setItem('time_log', JSON.stringify(state.ls));
      state.diag.ls = true;
    }catch(_e){ state.diag.ls = false; }
    tauTotal.textContent = fmtTimeAdaptive(state.ls.tau_total);
    visits.textContent = String(state.ls.visits);
  }

  /* ======= AUDIO ======= */
  function initAudio(){
    if(state.audio.ctx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    const ctxA = new AC({ latencyHint:'interactive' });
    const gain = ctxA.createGain(); gain.gain.value = 0.0;
    gain.connect(ctxA.destination);
    const osc = ctxA.createOscillator(); osc.type = 'sine';
    osc.frequency.value = state.audio.base;
    osc.connect(gain);
    osc.start();
    state.audio.ctx = ctxA; state.audio.osc = osc; state.audio.gain = gain;
  }
  function setToneTheme(f0){
    const root = document.documentElement;
    if(f0===128){ root.dataset.theme='warm'; state.audio.theme='warm'; }
    else if(f0===432){ root.dataset.theme='violet'; state.audio.theme='violet'; }
    else { root.dataset.theme='cool'; state.audio.theme='cool'; }
  }
  function setAudio(on){
    initAudio();
    const A = state.audio;
    if(!A.ctx) return;
    if(on){
      A.ctx.resume();
      const t = A.ctx.currentTime;
      A.gain.gain.cancelScheduledValues(t);
      A.gain.gain.linearRampToValueAtTime(A.vol, t+0.08);
      state.audio.on = true; state.audio.unlocked = true;
      audioToggle.setAttribute('aria-pressed','true');
      audioToggle.textContent = 'Pause';
      audioStatus.textContent = 'Audio running.';
    }else{
      const t = A.ctx.currentTime;
      A.gain.gain.cancelScheduledValues(t);
      A.gain.gain.linearRampToValueAtTime(0.0, t+0.08);
      state.audio.on = false;
      audioToggle.setAttribute('aria-pressed','false');
      audioToggle.textContent = 'Play';
      audioStatus.textContent = 'Audio stopped.';
    }
  }
  function onUserGesture(){
    if(!state.audio.unlocked){ setAudio(true); }
  }
  ['touchend','pointerup','keydown','mousedown'].forEach(ev=>document.addEventListener(ev, onUserGesture, {passive:true}));

  audioToggle.addEventListener('click', ()=> setAudio(!state.audio.on), {passive:true});
  volume.addEventListener('input', ()=>{ state.audio.vol = Number(volume.value); if(state.audio.ctx){ state.audio.gain.gain.setTargetAtTime(state.audio.vol, state.audio.ctx.currentTime, 0.03); }});
  alpha.addEventListener('input', ()=>{ state.audio.alpha = Number(alpha.value); });

  toneButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      toneButtons.forEach(b=>b.setAttribute('aria-pressed','false'));
      btn.setAttribute('aria-pressed','true');
      const f = Number(btn.dataset.tone);
      state.audio.base = f;
      setToneTheme(f);
      if(state.audio.ctx){ state.audio.osc.frequency.setTargetAtTime(f, state.audio.ctx.currentTime, 0.03); }
      state.ls.toneHz = f; saveLS();
    });
  });

  /* ======= MODE & SLIDERS ======= */
  const NU_MIN = 20, NU_MAX = 1e20;
  const M_MIN = 1e-9, M_MAX = 10;
  const logLabel = v => Number(v).toExponential(2);

  function switchMode(m){
    state.mode = m;
    photonControls.hidden = m!=='photon';
    restControls.hidden   = m!=='rest';
    relControls.hidden    = m!=='rel';
    state.ls.last_mode = m; saveLS();
  }
  modeSel.addEventListener('change', ()=> switchMode(modeSel.value));

  nu.addEventListener('input', ()=>{
    state.photon.slider = Number(nu.value);
    const f = mapLog(state.photon.slider/1000, NU_MIN, NU_MAX);
    nuLabel.textContent = `${fmtSI(f,'Hz',3)}`;
  });
  m0.addEventListener('input', ()=>{
    state.rest.slider = Number(m0.value);
    const m = mapLog(state.rest.slider/1000, M_MIN, M_MAX);
    m0Label.textContent = `${fmtSI(m,'kg',3)}`;
  });
  mr.addEventListener('input', ()=>{
    state.rel.mSlider = Number(mr.value);
    const m = mapLog(state.rel.mSlider/1000, M_MIN, M_MAX);
    mrLabel.textContent = `${fmtSI(m,'kg',3)}`;
  });
  beta.addEventListener('input', ()=>{
    state.rel.beta = Number(beta.value);
    betaLabel.textContent = state.rel.beta.toFixed(3);
  });

  [Lref,Mref].forEach(inp=> inp.addEventListener('change', ()=>{
    const L = Math.max(1e-12, Number(Lref.value) || 1);
    const M = Math.max(1e-12, Number(Mref.value) || 1);
    state.calib.L = L; state.calib.M = M; saveLS();
  }));

  // Initialize slider labels to defaults
  (function initLabels(){
    nu.dispatchEvent(new Event('input'));
    m0.dispatchEvent(new Event('input'));
    mr.dispatchEvent(new Event('input'));
    beta.dispatchEvent(new Event('input'));
  })();

  /* ======= PHYSICS ======= */
  function energyAndTau(){
    const K = Number(Lref.value)/Number(Mref.value);
    let E=0, EeV=0, lambda=NaN, gam=1, nuHz=NaN, mkg=NaN, bb=NaN;

    if(state.mode==='photon'){
      nuHz = mapLog(state.photon.slider/1000, NU_MIN, NU_MAX);
      E = C.h * nuHz;
      lambda = C.c/nuHz;
      EeV = E/C.e;
    }else if(state.mode==='rest'){
      mkg = mapLog(state.rest.slider/1000, M_MIN, M_MAX);
      E = mkg * C.c*C.c;
      EeV = E/C.e;
    }else{ // rel
      mkg = mapLog(state.rel.mSlider/1000, M_MIN, M_MAX);
      bb = clamp(state.rel.beta, 0, 0.99);
      gam = 1/Math.sqrt(1-bb*bb);
      E = (gam-1) * mkg * C.c*C.c; // kinetic energy
      EeV = E/C.e;
    }
    const tau = (E/Math.pow(C.c,3)) * K;

    // Persist to state
    Object.assign(state, { E, EeV, lambda, gamma:gam, tau, nuHz, mkg, bb });

    return state;
  }

  /* ======= EXAMPLES CHECK (K=1) ======= */
  function examplesOK(){
    const eps = 0.005; // ¬±0.5 %
    // 1) Photon 500 THz
    const E1 = C.h * (500e12);
    const tau1 = E1/Math.pow(C.c,3);
    const eV1 = E1/C.e;
    const lam1 = C.c/(500e12);
    const ok1 = (Math.abs(E1-3.3130e-19)/3.3130e-19) <= eps &&
                (Math.abs(eV1-2.0678)/2.0678) <= eps &&
                (Math.abs(lam1-5.996e-7)/5.996e-7) <= eps &&
                (Math.abs(tau1-1.2296e-44)/1.2296e-44) <= eps;

    // 2) Rest mass 1 kg
    const E2 = 1*Math.pow(C.c,2);
    const tau2 = E2/Math.pow(C.c,3);
    const ok2 = (Math.abs(E2-8.9876e16)/8.9876e16)<=eps &&
                (Math.abs(tau2-3.3356e-9)/3.3356e-9)<=eps;

    // 3) Relativistic kinetic 1 kg @ 0.90c
    const gam3 = 1/Math.sqrt(1-0.9*0.9);
    const E3 = (gam3-1)*Math.pow(C.c,2);
    const tau3 = E3/Math.pow(C.c,3);
    const ok3 = (Math.abs(gam3-2.294)/2.294)<=eps &&
                (Math.abs(E3-1.1631e17)/1.1631e17)<=eps &&
                (Math.abs(tau3-4.3168e-9)/4.3168e-9)<=eps;

    const pass = ok1 && ok2 && ok3;
    state.examplesOK = pass;
    examplesChip.classList.toggle('ok', pass);
    examplesChip.classList.toggle('bad', !pass);
    examplesChip.setAttribute('title', pass? 'Worked examples verified (¬±0.5%)' : 'Examples out of tolerance');
  }

  /* ======= CANVAS PARTICLES ======= */
  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const rect = cv.getBoundingClientRect();
    cv.width = Math.floor(rect.width * dpr);
    cv.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});
  resize();

  // Particle field
  const N = state.reduced ? 60 : 160;
  const particles = [];
  const center = { x:0, y:0 };
  const rand = n=>Math.random()*n;
  const range = (a,b)=>a+Math.random()*(b-a);
  function resetParticle(p){
    const W = cv.clientWidth, H = cv.clientHeight, R = Math.min(W,H)*0.42;
    const r = range(R*0.3, R*0.95);
    const ang = Math.random()*Math.PI*2;
    p.x = center.x + Math.cos(ang)*r;
    p.y = center.y + Math.sin(ang)*r;
    // tangential speed (aesthetic)
    const v = (0.6 + Math.random()*0.4) * (1.2 - r/(R*1.1));
    p.vx = -Math.sin(ang)*v;
    p.vy =  Math.cos(ang)*v;
    p.life = 0;
  }
  for(let i=0;i<N;i++){ particles.push({x:0,y:0,vx:0,vy:0,life:0}); resetParticle(particles[i]); }

  /* ======= RENDER LOOP ======= */
  function update(){
    const now = performance.now();
    const dt = Math.min(0.05, (now - state.time.last)/1000); // seconds
    state.time.last = now;
    state.time.acc = state.time.acc*0.9 + (1/dt)*0.1;
    state.time.fps = state.time.acc;

    const { E, EeV, lambda, gamma, tau, nuHz, mkg, bb } = energyAndTau();

    // Accumulate œÑ for localStorage
    state.ls.tau_total += Math.max(0, tau*dt);
    // Attempt save occasionally without spamming storage
    if((now|0)%1500 < 17){ saveLS(); }

    // Audio pitch bend (phase-locked-ish to render loop)
    if(state.audio.ctx && state.audio.on){
      const t = state.audio.ctx.currentTime;
      const f = state.audio.base / (1 + state.audio.alpha * tau);
      const fClamped = clamp(f, 20, 18000);
      state.audio.osc.frequency.setValueAtTime(fClamped, t);
    }

    // Diagnostics
    state.diag.audio = !!(state.audio.ctx && state.audio.on && state.audio.ctx.state==='running');
    state.diag.fps = state.time.fps >= 30;
    state.diag.tau = isFinite(tau);
    setChip(audioChip, state.diag.audio, 'Audio running', 'Tap Play to unlock audio');
    setChip(fpsChip, state.diag.fps, 'Frame rate healthy', 'Frame rate low (reduce other tabs)');
    setChip(tauChip, state.diag.tau, 'œÑ updated', 'œÑ not updating');
    setChip(lsChip, state.diag.ls, 'localStorage OK', 'localStorage disabled');

    diagAudio.textContent = state.diag.audio ? '‚úÖ Audio active' : '‚ùå Audio inactive (press Play)';
    diagFPS.textContent = state.diag.fps ? '‚úÖ Canvas ‚â• 30 fps' : '‚ùå Canvas < 30 fps';
    diagTau.textContent = state.diag.tau ? '‚úÖ œÑ_eff updating' : '‚ùå œÑ missing';
    diagLS.textContent = state.diag.ls ? '‚úÖ localStorage working' : '‚ùå localStorage blocked';

    // UI Readouts
    const K = Number(Lref.value)/Number(Mref.value);
    modeVal.textContent = state.mode;
    kVal.innerHTML = Number.isFinite(K)? K.toPrecision(4) : '‚Äî';

    if(state.mode==='photon'){
      const f = nuHz;
      nuVal.textContent = fmtSI(f,'Hz',3);
      lambdaVal.textContent = fmtSI(lambda,'m',3);
      mVal.textContent = '‚Äî'; bVal.textContent = '‚Äî'; gammaVal.textContent='‚Äî';
    }else if(state.mode==='rest'){
      nuVal.textContent = '‚Äî'; lambdaVal.textContent = '‚Äî'; bVal.textContent='‚Äî'; gammaVal.textContent='‚Äî';
      mVal.textContent = fmtSI(mkg,'kg');
    }else{
      nuVal.textContent = '‚Äî'; lambdaVal.textContent = '‚Äî';
      mVal.textContent = fmtSI(mkg,'kg'); bVal.textContent = (bb??0).toFixed(3);
      gammaVal.textContent = (gamma??1).toFixed(3);
    }
    EVal.textContent = `${fmtSI(E,'J',4)}`;
    EeVVal.textContent = `${Number(EeV.toPrecision(4))} eV`;
    const tauTxt = `${fmtTimeAdaptive(tau)}  (${(tau/T_PLANCK).toFixed(3)} t‚Çö)`;
    tauVal.textContent = tauTxt;
    lambdaOut.textContent = state.mode==='photon' ? fmtSI(lambda,'m',3) : '‚Äî';
    tauTotal.textContent = fmtTimeAdaptive(state.ls.tau_total);

    // Update frequency label live
    if(state.mode==='photon'){ nuLabel.textContent = fmtSI(nuHz,'Hz',3); }
    if(state.mode==='rest'){ m0Label.textContent = fmtSI(mkg,'kg',3); }
    if(state.mode==='rel'){ mrLabel.textContent = fmtSI(mkg,'kg',3); betaLabel.textContent = (bb??0).toFixed(3); }

    // Examples validation (periodic)
    if(((now|0)%1000)<17) examplesOK();

    // Draw
    draw(now, dt, tau);

    requestAnimationFrame(update);
  }

  function draw(now, dt, tau){
    const W = cv.clientWidth, H = cv.clientHeight;
    center.x = W/2; center.y = H/2;

    const normTau = (()=>{
      const l = Math.log10(Math.max(1e-50, tau));
      const t = clamp((l - (-46)) / ((-8) - (-46)), 0, 1); // map log10 œÑ from ~1e-46..1e-8 to 0..1
      return t;
    })();
    const hue = 260 - 250*normTau; // low œÑ -> violet, high œÑ -> red
    const clear = state.reduced ? 0.28 : lerp(0.08, 0.02, normTau); // longer trails with higher œÑ

    // Trail clear
    ctx.save();
    ctx.globalCompositeOperation = 'source-over';
    ctx.globalAlpha = clear;
    ctx.fillStyle = '#05060b';
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    // Gravity parameter (aesthetic curvature tied to M_ref/L_ref and œÑ)
    const K = Number(Lref.value)/Number(Mref.value);
    const mu = (state.reduced? 250 : 600) * (Number(Mref.value)/Math.max(1e-12, Number(Lref.value))) * (1+ 0.15*normTau);

    // Particles
    for(let i=0;i<particles.length;i++){
      const p = particles[i];
      const dx = (center.x - p.x), dy = (center.y - p.y);
      const r2 = dx*dx + dy*dy;
      const r = Math.sqrt(r2) + 0.0001;
      // pseudo-gravity (curvature)
      const acc = mu/(r2+80);
      const ax = acc*(dx/r), ay = acc*(dy/r);
      // integrate
      p.vx += ax*dt*0.5;
      p.vy += ay*dt*0.5;
      p.x += p.vx;
      p.y += p.vy;
      p.life += dt;
      if(r < 8 || r > Math.max(W,H)) resetParticle(p);
    }

    // Draw star/glass and center mass
    const g = ctx.createRadialGradient(center.x, center.y, 0, center.x, center.y, Math.min(W,H)*0.5);
    g.addColorStop(0, `hsla(${hue}, 90%, 65%, 0.10)`);
    g.addColorStop(1, 'rgba(255,255,255,0.00)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // Central mass
    ctx.beginPath();
    ctx.arc(center.x, center.y, 10, 0, Math.PI*2);
    ctx.fillStyle = `hsla(${hue}, 90%, 70%, 0.85)`;
    ctx.shadowColor = `hsla(${hue},100%,70%,0.6)`;
    ctx.shadowBlur = 16;
    ctx.fill();
    ctx.shadowBlur = 0;

    // Photon trails
    ctx.globalCompositeOperation = 'lighter';
    const trailAlpha = state.reduced ? 0.35 : lerp(0.28, 0.70, normTau);
    ctx.strokeStyle = `hsla(${hue}, 100%, 70%, ${trailAlpha})`;
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    for(let i=0;i<particles.length;i++){
      const p = particles[i];
      ctx.moveTo(p.x, p.y);
      ctx.lineTo(p.x - p.vx*2, p.y - p.vy*2);
    }
    ctx.stroke();
    ctx.globalCompositeOperation = 'source-over';
  }

  /* ======= SAVE / RESET ======= */
  saveBtn.addEventListener('click', ()=>{
    const snapshot = {
      time_log: state.ls,
      now: new Date().toISOString(),
      state: {
        mode: state.mode,
        toneHz: state.audio.base,
        alpha: state.audio.alpha,
        calibration: { Lref:Number(Lref.value), Mref:Number(Mref.value) },
        photonSlider: state.photon.slider,
        restSlider: state.rest.slider,
        rel: { mSlider: state.rel.mSlider, beta: state.rel.beta }
      }
    };
    const blob = new Blob([JSON.stringify(snapshot,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'time_illumina_v5_snapshot.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  resetBtn.addEventListener('click', ()=>{
    try{ localStorage.removeItem('time_log'); }catch(_e){}
    state.ls = { visits:1, tau_total:0, last_mode:'photon', toneHz:160, calibration:{Lref:1,Mref:1} };
    Lref.value = 1; Mref.value = 1; saveLS();
  });

  /* ======= KEYBOARD ======= */
  window.addEventListener('keydown', (e)=>{
    if(e.key==='p'){ setAudio(!state.audio.on); }
    else if(e.key==='t'){
      const order=[128,160,432];
      const idx = order.indexOf(state.audio.base);
      const next = order[(idx+1)%order.length];
      document.querySelector(`.tone[data-tone="${next}"]`).click();
    }else if(e.key==='m'){
      const opts=['photon','rest','rel'];
      const i=opts.indexOf(state.mode);
      const next=opts[(i+1)%opts.length];
      modeSel.value = next; switchMode(next);
    }else if(e.key==='s'){ saveBtn.click(); }
    else if(e.key==='r'){ resetBtn.click(); }
  });

  /* ======= SERVICE WORKER (inline via Blob) ======= */
  (function registerSW(){
    if(!('serviceWorker' in navigator)) return;
    const swCode = `
      const CACHE = 'time-illumina-v5-cache-v1';
      self.addEventListener('install', e=>{
        e.waitUntil((async()=>{
          const c = await caches.open(CACHE);
          await c.addAll([self.registration.scope || './', './']);
          await self.skipWaiting();
        })());
      });
      self.addEventListener('activate', e=>{
        e.waitUntil((async()=>{ await self.clients.claim(); })());
      });
      self.addEventListener('fetch', e=>{
        const req = e.request;
        if(req.method!=='GET') return;
        if(req.mode==='navigate'){
          e.respondWith((async()=>{
            try{ const net = await fetch(req); const cc = await caches.open(CACHE); cc.put(req, net.clone()); return net; }
            catch(_){ const c = await caches.open(CACHE); const r = await c.match(req) || await c.match('./'); return r; }
          })());
        }else{
          e.respondWith((async()=>{
            const c = await caches.open(CACHE);
            const m = await c.match(req); if(m) return m;
            try{ const net = await fetch(req); c.put(req, net.clone()); return net; }catch(_){ return new Response('',{status:504}); }
          })());
        }
      });
    `;
    const blob = new Blob([swCode], {type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).catch(()=>{ /* silent */ });
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  })();

  /* ======= START ======= */
  loadLS();
  examplesOK(); // initial
  requestAnimationFrame(update);

})();
</script>

<!-- Opening Line for New Chat: ‚ÄúHi, I‚Äôm Tristan. Let‚Äôs build Time ¬∑ Illumina v5 ‚Äî Gravity of Knowing (Physics Build).‚Äù -->
</body>
</html>
