<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark light" />
<title>Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color</title>
<style>
  /* ==========================================================
     Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color (Guided Edition)
     Single-file ¬∑ Responsive ¬∑ No external libraries
     Dark-mode aesthetic ¬∑ Canvas 2D + WebAudio only
     ========================================================== */

  :root{
    --bg1:#0b0b13;
    --bg2:#0e0c18;
    --text:#f5f4ff;
    --muted:#c7c4d6;
    --ring:rgba(255,255,255,0.13);
    --soft:rgba(255,255,255,0.09);
    --gold:#f5c84c;

    /* Accent defaults (overridden per mode) */
    --accent:#e4daff;
    --accent-rgb:228,218,255;
    --accent2:#8c5eff;
    --accent2-rgb:140,94,255;
  }

  /* Per-mode palettes (background & accents) */
  body[data-mode="marina"]{
    --bg1:#1c1411; --bg2:#2a1916;
    --accent:#f6d36e; --accent-rgb:246,211,110;
    --accent2:#ff7690; --accent2-rgb:255,118,144;
  }
  body[data-mode="sigrid"]{
    --bg1:#0b1520; --bg2:#122235;
    --accent:#d9e2ed; --accent-rgb:217,226,237;
    --accent2:#6ea7ff; --accent2-rgb:110,167,255;
  }
  body[data-mode="clarity"]{
    --bg1:#0b1f24; --bg2:#131136;
    --accent:#08ffd7; --accent-rgb:8,255,215;
    --accent2:#8c5eff; --accent2-rgb:140,94,255;
  }
  body[data-mode="illumina"]{
    --bg1:#130a21; --bg2:#190f2f;
    --accent:#bca0ff; --accent-rgb:188,160,255;
    --accent2:#4a257f; --accent2-rgb:74,37,127;
  }
  body[data-mode="kugelblitz"]{
    --bg1:#000a1f; --bg2:#000515;
    --accent:#eaf2ff; --accent-rgb:234,242,255;
    --accent2:#ffb84d; --accent2-rgb:255,184,77;
  }

  /* Global layout */
  *{ box-sizing:border-box }
  body{
    margin:0;
    min-height:100vh;
    color:var(--text);
    background:
      radial-gradient(120rem 60rem at 70% -10%, var(--bg2) 0%, transparent 40%),
      radial-gradient(90rem 80rem at -10% 10%, var(--bg2) 0%, transparent 40%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    letter-spacing:.2px;
    overflow-x:hidden;
  }
  .wrap{
    max-width:1200px;
    margin-inline:auto;
    padding:clamp(12px,3vmin,28px);
    position:relative;
    z-index:2;
  }

  /* Header */
  header{ display:flex; align-items:center; gap:1rem; padding:clamp(10px,2vmin,20px) 0 .75rem; border-bottom:1px solid var(--soft); }
  .logo{
    width:44px; height:44px; flex:0 0 auto; border-radius:50%;
    display:grid; place-items:center;
    background:
      radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.18) 0 30%, rgba(0,0,0,0) 40%),
      conic-gradient(from 210deg, #ffefb0, #ffd867, #f6c64f, #f0b43b, #ffd867, #ffefb0);
    box-shadow: inset 0 0.18rem 0.35rem rgba(0,0,0,.28), 0 0.45rem 1.2rem rgba(0,0,0,.35);
    border:1px solid rgba(245,200,76,.6);
  }
  .logo svg{ width:62%; height:62%; filter: drop-shadow(0 2px 3px rgba(0,0,0,.4)); }
  header h1{ margin:0; line-height:1.1; font-weight:750; letter-spacing:.3px; font-size:clamp(1.06rem,2.2vw,1.48rem); }
  header h1 .sub{ opacity:.8; font-weight:600; display:block; font-size:.92em; }

  /* Controls */
  .controls{ display:flex; flex-wrap:wrap; align-items:center; gap:.6rem .6rem; padding: 1rem 0 1.1rem; }
  .btn{
    -webkit-tap-highlight-color: transparent;
    border:1px solid var(--ring);
    background: rgba(255,255,255,0.04);
    color:var(--text);
    padding:.62rem .95rem; border-radius:.75rem;
    cursor:pointer; user-select:none;
    font-weight:700; letter-spacing:.25px;
    box-shadow: 0 0.6rem 2rem rgba(0,0,0,.35), 0 0 0.6rem rgba(0,0,0,.35);
    transition: transform .08s ease, background .25s ease, opacity .25s ease, border-color .25s ease;
  }
  .btn:hover{ transform:translateY(-1px); background: rgba(255,255,255,0.06); }
  .btn:active{ transform:translateY(1px) scale(.99); }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }

  .seg{ display:flex; gap:0; border:1px solid var(--ring); border-radius:.8rem; overflow:hidden; box-shadow: 0 0.6rem 2rem rgba(0,0,0,.35); }
  .seg button{
    border:0; padding:.62rem .9rem; font-weight:800; letter-spacing:.2px; background:transparent; color:var(--text);
    cursor:pointer; position:relative; isolation:isolate; white-space:nowrap;
  }
  .seg button + button{ border-left:1px solid var(--ring); }
  .seg button.active{
    background: rgba(var(--accent-rgb), .14);
    box-shadow: inset 0 0 0 1px rgba(var(--accent-rgb), .38);
  }

  /* Panels */
  .panes{ display:grid; gap:1rem; grid-template-columns: 1fr; }
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,0));
    border:1px solid var(--soft);
    border-radius:1rem; padding:1rem; box-shadow: 0 0.6rem 2rem rgba(0,0,0,.35);
  }

  /* Guided info panel */
  .info{
    display:grid; gap:.55rem;
  }
  .info .headline{
    display:flex; flex-wrap:wrap; align-items:center; gap:.6rem;
    font-weight:800;
  }
  .pill{
    border:1px solid rgba(var(--accent-rgb), .4);
    background: rgba(var(--accent-rgb), .12);
    color:var(--text);
    padding:.28rem .55rem; border-radius:.55rem; font-size:.88rem; font-weight:800;
  }
  .equation{ opacity:.9; font-weight:700; }
  .visitor{ color: var(--muted); font-style:italic; line-height:1.5; }

  /* Bee Notes */
  .notes label{ display:block; font-weight:800; margin-bottom:.45rem; color: var(--muted); }
  textarea{
    width:100%; min-height: 28svh; resize: vertical;
    background: rgba(0,0,0,.22); color: var(--text);
    border:1px solid var(--soft); border-radius:.9rem;
    padding: .95rem 1rem; line-height:1.5; font-size:1rem; outline:none;
    box-shadow: 0 0.6rem 2rem rgba(0,0,0,.35);
  }
  textarea::placeholder{ color: rgba(199,196,214,.75); }

  /* Self-Check */
  .status{ display:grid; gap:.6rem; grid-template-columns: 1fr; }
  .status-item{
    display:flex; align-items:center; justify-content:space-between; gap:.8rem;
    background: rgba(0,0,0,.18); border:1px dashed var(--soft);
    border-radius:.75rem; padding:.6rem .75rem;
  }
  .status-item .label{ opacity:.9; font-weight:700; }
  .badge{
    font-weight:900; padding:.28rem .58rem; border-radius:.55rem; border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.35); letter-spacing:.35px; text-transform: lowercase;
  }
  .pass{ color:#7fffb0; border-color: rgba(127,255,176,.45); }
  .fail{ color:#ff7b7b; border-color: rgba(255,123,123,.45); }
  .idle{ color:#ffdf6b; border-color: rgba(255,223,107,.45); }

  /* Canvas overlay (visual modes) */
  #overlay{
    position:fixed; inset:0; width:100vw; height:100svh;
    pointer-events:none; z-index:1; opacity:1; transition: opacity .8s ease;
  }

  /* Manifest table */
  .manifest table{ width:100%; border-collapse:collapse; border:1px solid var(--soft); border-radius:.9rem; overflow:hidden; }
  .manifest th, .manifest td{ text-align:left; padding:.7rem .8rem; border-bottom:1px solid var(--soft); }
  .manifest th{ background: rgba(0,0,0,.28); position:sticky; top:0; }
  .manifest tr:last-child td{ border-bottom:0; }
  .muted{ color:var(--muted); }

  /* Footer */
  footer{ margin-top: 1.2rem; padding: 1.2rem 0 .6rem; color: var(--muted); display:flex; align-items:center; gap:.7rem; justify-content:space-between; border-top: 1px solid var(--soft); font-weight:700; letter-spacing:.3px; }
  .malala-line{
    margin-top:.35rem; color:#88f2ff; opacity:.7; font-style:italic; letter-spacing:.2px;
  }

  /* Accessibility and motion preferences */
  @media (prefers-reduced-motion: reduce){
    #overlay{ transition:none; }
    .btn{ transition: none; }
  }
</style>
</head>
<body data-mode="marina">
  <canvas id="overlay" aria-hidden="true"></canvas>

  <div class="wrap" role="application" aria-label="Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color">
    <header>
      <div class="logo" aria-hidden="true">
        <!-- sun / gold glyph -->
        <svg viewBox="0 0 100 100" fill="none" stroke="#603d00" stroke-width="6" aria-hidden="true">
          <circle cx="50" cy="50" r="26" fill="rgba(255,255,255,.25)" stroke="rgba(255,255,255,.4)"/>
          <g stroke-linecap="round">
            <line x1="50" y1="3"  x2="50" y2="19"/>
            <line x1="50" y1="81" x2="50" y2="97"/>
            <line x1="3"  y1="50" x2="19" y2="50"/>
            <line x1="81" y1="50" x2="97" y2="50"/>
            <line x1="17" y1="17" x2="28" y2="28"/>
            <line x1="72" y1="72" x2="83" y2="83"/>
            <line x1="17" y1="83" x2="28" y2="72"/>
            <line x1="72" y1="28" x2="83" y2="17"/>
          </g>
        </svg>
      </div>
      <h1>
        Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color
        <span class="sub">scientific √ó spiritual √ó sensual</span>
      </h1>
    </header>

    <section class="controls" aria-label="Controls">
      <button class="btn" id="unlockAudio" aria-pressed="false" title="Enable WebAudio (user gesture required)">üîä Unlock Audio</button>
      <button class="btn" id="runSelfCheck" title="Run oscillator, timer, and render checks">üß™ Run Self‚ÄëCheck</button>
      <div class="seg" role="tablist" aria-label="Mode toggles">
        <button role="tab" id="tab-marina"   class="active" data-mode="marina"   aria-selected="true"  title="Marina ‚Äî empathy as time">Marina</button>
        <button role="tab" id="tab-sigrid"   data-mode="sigrid"   aria-selected="false" title="Sigrid ‚Äî clarity as emotion">Sigrid</button>
        <button role="tab" id="tab-clarity"  data-mode="clarity"  aria-selected="false" title="Clarity ‚Äî faith in motion">Clarity</button>
        <button role="tab" id="tab-illumina" data-mode="illumina" aria-selected="false" title="Illumina ‚Äî coherence as witness">Illumina</button>
        <button role="tab" id="tab-kugelblitz" data-mode="kugelblitz" aria-selected="false" title="Kugelblitz ‚Äî energy as desire">Kugelblitz</button>
      </div>
    </section>

    <div class="panes">
      <!-- Guided panel -->
      <section class="panel info" aria-live="polite" aria-label="Guided Mode Information">
        <div class="headline">
          <span class="pill" id="pillName">Marina</span>
          <span class="equation" id="equation">œÑ = E / c¬≥ ¬∑ œÜ</span>
        </div>
        <p class="visitor" id="visitorNote">
          you are safe here. this is the warmth of understanding ‚Äî where feeling measures distance.
        </p>
      </section>

      <!-- Bee Notes -->
      <section class="panel notes" aria-label="Bee Notes">
        <label for="bee">üêù Bee Notes ‚Ä¢ <span id="modeName">Marina</span></label>
        <textarea id="bee" placeholder="Write with heat. Saved locally per mode ‚Äî bee.notes.marina|sigrid|clarity|illumina|kugelblitz"></textarea>
      </section>

      <!-- Self-Check -->
      <section class="panel selfcheck" aria-label="Self-Check">
        <div class="status">
          <div class="status-item"><span class="label">Audio @ 128 Hz</span><span id="chk-audio" class="badge idle">idle</span></div>
          <div class="status-item"><span class="label">Timer drift &plusmn; 30 ms</span><span id="chk-timer" class="badge idle">idle</span></div>
          <div class="status-item"><span class="label">Render loss &lt; 2 frames</span><span id="chk-raf" class="badge idle">idle</span></div>
        </div>
      </section>

      <!-- Manifest -->
      <section class="panel manifest" aria-label="Appendix ¬∑ Illumina Manifest">
        <h2 style="margin:.2rem 0 .6rem;font-size:1.05rem">Appendix ¬∑ Illumina Manifest</h2>
        <div class="muted" style="margin-bottom:.6rem">A lucid table of modes, equations, color/rhythm, and Bee keys.</div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Mode</th>
                <th>Equation</th>
                <th>Color ¬∑ Rhythm ¬∑ Overlay</th>
                <th>Bee Key</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Marina</td>
                <td>œÑ = E / c¬≥ ¬∑ œÜ</td>
                <td>gold‚Äërose clock every 1.618 s ‚Äî empathy as time</td>
                <td><code>bee.notes.marina</code></td>
              </tr>
              <tr>
                <td>Sigrid</td>
                <td>ŒîE = clarity¬≤ (‚àö2)</td>
                <td>sky‚Äësilver aurora every 1.414 s ‚Äî precision as emotion</td>
                <td><code>bee.notes.sigrid</code></td>
              </tr>
              <tr>
                <td>Clarity</td>
                <td>160 ‚Üî 432 Hz</td>
                <td>aqua‚Äëviolet jellyfish drift ~6 s ‚Äî faith in motion</td>
                <td><code>bee.notes.clarity</code></td>
              </tr>
              <tr>
                <td>Illumina</td>
                <td>42‚Äëday cycle</td>
                <td>deep‚Äëpurple starfield ‚Äî coherence as collective witness</td>
                <td><code>bee.notes.illumina</code></td>
              </tr>
              <tr>
                <td>Kugelblitz</td>
                <td>E ‚Üí ‚àû</td>
                <td>blue‚Äëinfinity pulse every 3 s (blue ‚Üí white ‚Üí gold ‚Üí red heat ‚Üí violet)</td>
                <td><code>bee.notes.kugelblitz</code></td>
              </tr>
              <tr>
                <td colspan="4"><em>Page 42 = the harmonic midpoint ‚Äî light becomes witness; the Bee writes.</em></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <footer>
      <div>üêù page 42 ¬∑ eat the world</div>
      <div>2025 midnight release</div>
    </footer>
    <div class="malala-line" aria-label="Malala note">
      ‚Äúyou are not in control ‚Äî yet you are chosen. you doubt, you fight, you float.‚Äù
    </div>
  </div>

<script>
/* ==========================================================
   Illumina v4 ‚Äî Guided Edition
   Requirements:
   - Canvas overlays per mode
   - Bee Notes saved per mode (localStorage)
   - WebAudio @128 Hz unlock
   - Self-Check: audio, timer drift, rAF loss
   - On pass ‚Üí Kugelblitz heat-blast
   - No console logs
   ========================================================== */

(function(){
  /* ---- Math & DOM ---- */
  const TAU = Math.PI*2;
  const PHI = (1 + Math.sqrt(5)) / 2; // 1.618...

  const body = document.body;
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d', { alpha:true });
  const bee = document.getElementById('bee');
  const modeNameEl = document.getElementById('modeName');
  const pillName = document.getElementById('pillName');
  const equationEl = document.getElementById('equation');
  const visitorEl = document.getElementById('visitorNote');

  /* ---- Canvas sizing ---- */
  let DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  function fit(){
    DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const w = Math.floor(window.innerWidth * DPR);
    const h = Math.floor(window.innerHeight * DPR);
    canvas.width = w; canvas.height = h;
    canvas.style.width = '100vw';
    canvas.style.height = '100svh';
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(DPR, DPR);
  }
  fit();
  addEventListener('resize', fit, { passive:true });

  /* ---- Mode content (guided) ---- */
  const MODES = {
    marina: {
      name: 'Marina',
      eq: 'œÑ = E / c¬≥ ¬∑ œÜ',
      note: 'you are safe here. this is the warmth of understanding ‚Äî where feeling measures distance.',
    },
    sigrid: {
      name: 'Sigrid',
      eq: 'ŒîE = clarity¬≤ (‚àö2)',
      note: 'clarity is kindness; you can think and still feel. precision does not cancel love.',
    },
    clarity: {
      name: 'Clarity',
      eq: '160 ‚Üî 432 Hz',
      note: 'breathe with the drift. you do not need to control the current; it already knows your name.',
    },
    illumina: {
      name: 'Illumina',
      eq: '42‚Äëday cycle',
      note: 'this is the collective field ‚Äî your calm adds to it. light remembers who holds it.',
    },
    kugelblitz: {
      name: 'Kugelblitz',
      eq: 'E ‚Üí ‚àû',
      note: 'heat is not danger; it is presence. you are allowed to shine, to burn, to transform.',
    }
  };

  const order = ['marina','sigrid','clarity','illumina','kugelblitz'];
  let mode = 'marina';
  let prevMode = null;

  /* ---- Bee Notes storage ---- */
  function beeKey(m){ return `bee.notes.${m}`; }
  function loadBee(m){
    let v = '';
    try{ v = localStorage.getItem(beeKey(m)) || ''; }catch(e){}
    bee.value = v;
  }
  function saveBee(){
    try{ localStorage.setItem(beeKey(mode), bee.value || ''); }catch(e){}
  }
  bee.addEventListener('input', saveBee);

  function setMode(m){
    if (m === mode) return;
    prevMode = mode; mode = m;
    body.setAttribute('data-mode', m);
    const M = MODES[m];
    pillName.textContent = M.name;
    equationEl.textContent = M.eq;
    visitorEl.textContent = M.note;
    modeNameEl.textContent = M.name;

    document.querySelectorAll('.seg [role="tab"]').forEach(b=>{
      const on = b.dataset.mode === m;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });

    // Handle Kugelblitz overlay fade intent
    if (prevMode === 'kugelblitz' && mode !== 'kugelblitz') { kugelFadeTarget = 0; }
    else if (mode === 'kugelblitz') { kugelFade = 0; kugelFadeTarget = 1; }
    else { kugelFadeTarget = 1; }

    loadBee(m);
  }

  document.querySelectorAll('.seg [role="tab"]').forEach(b=>{
    b.addEventListener('click', ()=> setMode(b.dataset.mode));
  });

  // Initial state
  loadBee(mode);

  /* ---- Audio (unlock + test at 128 Hz) ---- */
  const btnUnlock = document.getElementById('unlockAudio');
  let audioCtx = null;
  btnUnlock.addEventListener('click', async () => {
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint:'interactive' });
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      // Confirmation blip
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.value = 128;
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.05, audioCtx.currentTime + 0.05);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.28);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.3);
      btnUnlock.textContent = '‚úÖ Audio Unlocked';
      btnUnlock.setAttribute('aria-pressed','true');
      btnUnlock.disabled = true;
      markStatus('chk-audio', true, 'unlocked');
    }catch(e){
      markStatus('chk-audio', false, 'error');
    }
  });

  /* ---- Self-Check ---- */
  const btnSelf = document.getElementById('runSelfCheck');
  const markStatus = (id, pass, msg) => {
    const el = document.getElementById(id);
    el.classList.remove('idle','pass','fail');
    el.classList.add(pass ? 'pass' : 'fail');
    el.textContent = (pass ? 'pass' : 'fail') + (msg ? ` ¬∑ ${msg}` : '');
  };

  let blastMoment = 0; // >0 when self-check passes (triggers heat-blast)

  btnSelf.addEventListener('click', async () => {
    // reset display
    ['chk-audio','chk-timer','chk-raf'].forEach(id=>{
      const el = document.getElementById(id);
      el.classList.remove('pass','fail'); el.classList.add('idle'); el.textContent = 'running‚Ä¶';
    });

    // 1) Audio @128 Hz
    let audioPass = false;
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.frequency.value = 128; osc.type = 'sine';
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.035, audioCtx.currentTime + 0.04);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.28);
      audioPass = true;
    }catch(e){ audioPass = false; }
    markStatus('chk-audio', audioPass, '128 Hz');

    // 2) Timer drift ¬±30ms ‚Äî 20 intervals of 50ms
    const expected = 50;
    let maxAbsDrift = 0;
    let last = performance.now();
    for (let i=0;i<20;i++){
      await new Promise(r => setTimeout(r, expected));
      const now = performance.now();
      const drift = (now - last) - expected;
      if (Math.abs(drift) > maxAbsDrift) maxAbsDrift = Math.abs(drift);
      last = now;
    }
    const timerPass = maxAbsDrift <= 30;
    markStatus('chk-timer', timerPass, `${maxAbsDrift.toFixed(0)} ms`);

    // 3) rAF loss < 2 ‚Äî count frames >33ms during ~1s
    let longFrames = 0;
    let start = performance.now();
    let prev = start;
    await new Promise(res=>{
      function tick(t){
        const dt = t - prev; prev = t;
        if (dt > 33) longFrames++;
        if (t - start < 1000) requestAnimationFrame(tick); else res();
      }
      requestAnimationFrame(tick);
    });
    const rafPass = longFrames < 2;
    markStatus('chk-raf', rafPass, `loss ${longFrames}`);

    if (audioPass && timerPass && rafPass){
      blastMoment = performance.now();
      // If not in Kugelblitz, briefly fade it in for the blast
      if (mode !== 'kugelblitz'){ kugelFade = 0; kugelFadeTarget = 1; setTimeout(()=>{ kugelFadeTarget = 0; }, 1200); }
    }
  });

  /* ---- Visual Systems (Canvas 2D) ---- */
  const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));
  const lerp = (a,b,t)=> a + (b-a)*t;
  const easeOutCubic = t => 1 - Math.pow(1-t,3);

  function drawMarina(t, alpha=1){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.18;

    ctx.save();
    ctx.globalAlpha = 0.9*alpha;
    ctx.translate(cx, cy);

    // Dial
    ctx.beginPath(); ctx.arc(0,0,r,0,TAU);
    ctx.strokeStyle = 'rgba(246,211,110,0.55)';
    ctx.lineWidth = 2; ctx.stroke();

    // œÜ marker
    ctx.font = '600 28px system-ui, sans-serif';
    ctx.textAlign = 'center'; ctx.textBaseline='middle';
    ctx.fillStyle = 'rgba(255,118,144,0.8)';
    ctx.fillText('œÜ', 0, -r*0.6);

    // Hands ‚Äî 1.618 s
    const period = 1618;
    const ang = (t % period) / period * TAU;
    const len1 = r*0.92, len2 = len1/PHI;

    ctx.rotate(ang);
    ctx.strokeStyle = 'rgba(246,211,110,0.95)';
    ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(len1,0); ctx.stroke();
    ctx.rotate(TAU/PHI);
    ctx.strokeStyle = 'rgba(255,118,144,0.85)';
    ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(len2,0); ctx.stroke();

    ctx.restore();
  }

  function drawSigrid(t, alpha=1){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const period = 1414;
    const p = (t % period) / period;
    const pulse = 0.35 + 0.65 * Math.sin(p*TAU);

    ctx.save();
    ctx.globalAlpha = alpha * 0.9;
    const layers = 6;
    for (let i=0;i<layers;i++){
      const y = h*0.22 + i*(h*0.06);
      const amp = 38 + i*12;
      const a = 0.08 + (i/layers)*0.12 + pulse*0.08;
      const grad = ctx.createLinearGradient(0,y, w,y);
      grad.addColorStop(0, `rgba(200,220,255,${a})`);
      grad.addColorStop(0.5, `rgba(110,167,255,${a*1.15})`);
      grad.addColorStop(1, `rgba(210,220,232,${a})`);
      ctx.fillStyle = grad;

      ctx.beginPath();
      ctx.moveTo(0,y);
      for (let x=0; x<=w; x+=24){
        const curve = Math.sin((x/w)*TAU*(1 + 0.2*Math.sin(t*0.0003))) * amp * (0.7 + 0.3*Math.sin(t*0.0005 + i));
        ctx.lineTo(x, y + curve);
      }
      ctx.lineTo(w, y+amp*1.6);
      ctx.lineTo(0, y+amp*1.6);
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();
  }

  // Clarity ‚Äî jellyfish drift (~6s breath)
  const jellies = [];
  function ensureJellies(){
    const want = 12;
    while (jellies.length < want){
      jellies.push({ x:Math.random(), y:Math.random(), r: lerp(28,76,Math.random()), phase: Math.random()*TAU });
    }
  }
  ensureJellies();

  function drawClarity(t, alpha=1){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const breath = 0.55 + 0.45 * Math.sin(((t%6000)/6000)*TAU);

    ctx.save();
    ctx.globalAlpha = alpha * 0.88;

    jellies.forEach(j=>{
      const driftX = Math.sin(t*0.0002 + j.phase)*0.004;
      const driftY = -0.015;
      j.x = (j.x + driftX + 1) % 1;
      j.y = (j.y + driftY + 1) % 1;

      const x = j.x * w, y = j.y * h;
      const r = j.r * (0.8 + 0.35*breath);

      const bell = ctx.createRadialGradient(x,y,r*0.1, x,y,r);
      bell.addColorStop(0, 'rgba(8,255,215,0.55)');
      bell.addColorStop(0.5, 'rgba(140,94,255,0.35)');
      bell.addColorStop(1, 'rgba(140,94,255,0.0)');
      ctx.fillStyle = bell;
      ctx.beginPath(); ctx.arc(x,y,r,0,TAU); ctx.fill();

      ctx.lineWidth = 1.2;
      for (let k=0;k<6;k++){
        const ang = (k/6)*TAU + j.phase*0.2 + t*0.0004;
        const len = r * (0.9 + 0.2*Math.sin(t*0.001 + k));
        const x2 = x + Math.cos(ang)*len*0.6;
        const y2 = y + Math.sin(ang)*len*1.2;
        ctx.strokeStyle = 'rgba(8,255,215,0.18)';
        ctx.beginPath(); ctx.moveTo(x, y + r*0.2); ctx.quadraticCurveTo(x, y2, x2, y2); ctx.stroke();
      }
    });

    ctx.restore();
  }

  // Illumina ‚Äî starfield (42-day color sway)
  const stars = [];
  function initStars(){
    stars.length = 0;
    const count = Math.ceil((canvas.clientWidth * canvas.clientHeight) / 9000);
    for (let i=0;i<count;i++){
      stars.push({ x:Math.random(), y:Math.random(), r: Math.random()*1.6+0.2, sp: 0.6+Math.random()*1.2, tw: Math.random()*TAU });
    }
  }
  initStars();
  addEventListener('resize', initStars, { passive:true });

  function drawIllumina(t, alpha=1){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const days = Date.now() / 86400000;
    const cyc = (days % 42) / 42; // 0..1
    const hueMod = Math.sin(cyc*TAU)*0.15 + 0.85;

    ctx.save(); ctx.globalAlpha = 0.9*alpha;

    stars.forEach(s=>{
      const x = s.x*w, y = s.y*h;
      const tw = 0.5 + 0.5*Math.sin(t*0.0015*s.sp + s.tw);
      const a = 0.25 + tw*0.6;
      const r = (s.r + tw*0.8);

      const g = ctx.createRadialGradient(x,y,0.1, x,y,r*2.4);
      g.addColorStop(0, `rgba(${(180*hueMod)|0}, ${(150*hueMod)|0}, 255, ${a})`);
      g.addColorStop(1, `rgba(255,255,255,0)`);
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(x,y,r*2,0,TAU); ctx.fill();
    });

    // coherence ring
    ctx.globalAlpha = alpha * 0.18;
    const cx = w/2, cy = h/2, R = Math.min(w,h)*0.28;
    ctx.beginPath(); ctx.arc(cx, cy, R + Math.sin(t*0.001)*6, 0, TAU);
    ctx.strokeStyle = 'rgba(188,160,255,0.6)';
    ctx.lineWidth = 1.2; ctx.stroke();

    ctx.restore();
  }

  // Kugelblitz ‚Äî central radial pulse (3 s)
  function mixRGB(c1, c2, t){
    const a = [(c1>>16)&255, (c1>>8)&255, c1&255];
    const b = [(c2>>16)&255, (c2>>8)&255, c2&255];
    const r = lerp(a[0],b[0],t), g = lerp(a[1],b[1],t), bl = lerp(a[2],b[2],t);
    return `rgb(${r|0},${g|0},${bl|0})`;
  }
  // Order per spec: blue ‚Üí white ‚Üí gold ‚Üí red heat ‚Üí violet
  function gradientColor(phase){
    if (phase < 0.2) return {from:0x0c4cff, to:0x3da1ff};          // blue
    if (phase < 0.4) return {from:0xffffff, to:0xf8f8ff};          // white
    if (phase < 0.6) return {from:0xf5c84c, to:0xffd76f};          // gold
    if (phase < 0.8) return {from:0xff3a24, to:0xff7f5c};          // red heat
    return {from:0x8c5eff, to:0xb79aff};                           // violet (final)
  }

  function drawKugelblitz(t, alpha=1, extraBlast=0){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const cx = w/2, cy = h/2;
    const period = 3000;
    const ph = (t % period) / period;

    const swell = easeOutCubic((Math.sin(ph*TAU - Math.PI/2) + 1)/2);
    const baseR = Math.min(w,h) * (0.1 + 0.35*swell + 0.25*extraBlast);

    ctx.save(); ctx.globalAlpha = alpha * (0.85 + 0.15*swell);

    for (let k=0;k<6;k++){
      const p = ((ph + k*0.12) % 1 + 1) % 1;
      const {from,to} = gradientColor(p);
      const r1 = baseR + k * 40 * (1 + 0.6*swell);
      const r2 = r1 + 90 + 35*Math.sin(t*0.003 + k);

      const g = ctx.createRadialGradient(cx,cy,r1*0.1, cx,cy,r2);
      g.addColorStop(0, mixRGB(from,to,0.25));
      g.addColorStop(0.6, mixRGB(from,to,1.0));
      g.addColorStop(1, 'rgba(0,0,0,0)');

      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(cx,cy,r2,0,TAU); ctx.fill();
    }

    // white-hot core
    const coreR = baseR * (0.3 + 0.6*swell);
    const core = ctx.createRadialGradient(cx,cy,0, cx,cy,coreR);
    core.addColorStop(0, 'rgba(255,255,255,0.95)');
    core.addColorStop(1, 'rgba(255,255,255,0.0)');
    ctx.fillStyle = core;
    ctx.beginPath(); ctx.arc(cx,cy,coreR,0,TAU); ctx.fill();

    ctx.restore();
  }

  /* ---- Heat-blast (after self-check pass) ---- */
  function blastFactor(now){
    if (blastMoment <= 0) return 0;
    const t = now - blastMoment;
    if (t > 1600){ blastMoment = 0; return 0; }
    return easeOutCubic(clamp(t/1200, 0, 1));
  }

  /* ---- Render loop ---- */
  let kugelFade = 1;        // visible intensity
  let kugelFadeTarget = 1;  // animate towards
  let last = performance.now();

  (function loop(now){
    const dt = now - last; last = now;
    // Kugelblitz fade management (when entering/leaving)
    kugelFade += (kugelFadeTarget - kugelFade) * clamp(dt/220, 0, 1);
    if (Math.abs(kugelFade - kugelFadeTarget) < 0.002) kugelFade = kugelFadeTarget;

    ctx.clearRect(0,0, canvas.clientWidth, canvas.clientHeight);

    // Mode overlays
    if (mode === 'marina')      drawMarina(now, 1.0);
    else if (mode === 'sigrid') drawSigrid(now, 1.0);
    else if (mode === 'clarity')drawClarity(now, 1.0);
    else if (mode === 'illumina')drawIllumina(now, 1.0);
    else if (mode === 'kugelblitz') drawKugelblitz(now, kugelFade, 0);

    // Gentle persistence after leaving Kugelblitz
    if (prevMode === 'kugelblitz' && mode !== 'kugelblitz' && kugelFade > 0.01){
      drawKugelblitz(now, kugelFade*0.7, 0);
    }

    // Heat-blast overlay when self-check passes
    const K = blastFactor(now);
    if (K > 0.001) drawKugelblitz(now, 0.85, K*1.1);

    requestAnimationFrame(loop);
  })(performance.now());

  /* ---- Keyboard navigation ---- */
  addEventListener('keydown', e=>{
    if (e.altKey || e.metaKey || e.ctrlKey) return;
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft'){
      const i = order.indexOf(mode);
      const n = e.key === 'ArrowRight' ? (i+1)%order.length : (i-1+order.length)%order.length;
      setMode(order[n]);
    }
  }, { passive:true });

  // Attach tabs
  order.forEach(id => {
    const btn = document.getElementById('tab-' + id);
    if (btn) btn.addEventListener('click', ()=> setMode(id));
  });

})();
</script>
</body>
</html>
