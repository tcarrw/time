<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color</title>
<meta name="color-scheme" content="dark light" />
<style>
  /* =======================
     Illumina v4 ¬∑ Kugelblitz
     Single-file ¬∑ Inline CSS
     ======================= */

  :root {
    --bg1: #0b0b13;
    --bg2: #0e0c18;
    --text: #f5f4ff;
    --muted: #c7c4d6;
    --soft: rgba(255,255,255,0.08);
    --ring: rgba(255,255,255,0.12);
    --gold: #f5c84c;
    --link: #d6ccff;
    --ok: #7fffb0;
    --warn: #ffdf6b;
    --bad: #ff7b7b;
    --accent: #f5c84c;  /* will be overridden per-mode */
    --accent2:#ff8fa3;
    --shadow: 0 0 0.6rem rgba(0,0,0,0.35), 0 0.6rem 2rem rgba(0,0,0,0.35);
  }

  /* Mode palettes (background gradient + accents) */
  body {
    margin:0;
    min-height:100svh;
    color:var(--text);
    background:
      radial-gradient(120rem 60rem at 70% -10%, var(--bg2) 0%, transparent 40%),
      radial-gradient(90rem 80rem at -10% 10%, var(--bg2) 0%, transparent 40%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    letter-spacing: .2px;
    overflow-x:hidden;
  }

  body[data-mode="marina"] {
    --bg1:#1e1412; --bg2:#2a1916;
    --accent:#f6d36e; --accent2:#ff7690;
  }
  body[data-mode="sigrid"] {
    --bg1:#0c1622; --bg2:#142132;
    --accent:#d9e2ed; --accent2:#6ea7ff;
  }
  body[data-mode="clarity"] {
    --bg1:#0b1f24; --bg2:#141136;
    --accent:#08ffd7; --accent2:#8c5eff;
  }
  body[data-mode="illumina"] {
    --bg1:#130a21; --bg2:#1b0f2f;
    --accent:#bca0ff; --accent2:#4a257f;
  }
  body[data-mode="kugelblitz"] {
    --bg1:#001028; --bg2:#00081a;
    --accent:#eaf2ff; --accent2:#ffb84d;
  }

  /* Layout */
  .wrap {
    max-width: 1200px;
    margin-inline:auto;
    padding: clamp(12px, 3vmin, 28px);
    position:relative;
    z-index:2;
  }

  header {
    display:flex; align-items:center; gap:1rem;
    padding: clamp(10px, 2vmin, 20px) 0 0.75rem;
    border-bottom: 1px solid var(--soft);
    position:relative;
  }
  .logo {
    width:42px; height:42px; flex: 0 0 auto;
    display:grid; place-items:center;
    border-radius:50%;
    background: radial-gradient(120% 120% at 30% 20%, #fff5 0 30%, #0000 40%),
                conic-gradient(from 210deg, #ffefb0, #ffd867, #f6c64f, #f0b43b, #ffd867, #ffefb0);
    box-shadow: inset 0 0.15rem 0.35rem rgba(0,0,0,.25), 0 0.4rem 1.2rem rgba(0,0,0,.35);
    border: 1px solid color-mix(in oklab, var(--gold) 60%, #ffffff 40%);
  }
  .logo svg { width:62%; height:62%; filter: drop-shadow(0 2px 3px rgba(0,0,0,.4)); }
  header h1 {
    margin:0; line-height:1.1;
    font-weight:700; letter-spacing:.3px;
    font-size: clamp(1.05rem, 2.2vw, 1.45rem);
  }
  header h1 .sub { opacity:.8; font-weight:600; display:block; font-size:.92em; }
  .note {
    margin:.35rem 0 0.2rem 0;
    font-style: italic; color: var(--muted);
    font-size: clamp(.86rem, 1.8vw, .98rem);
  }

  /* Controls */
  .controls {
    display:flex; flex-wrap:wrap; align-items:center; gap:.6rem .6rem;
    padding: 1rem 0 1.2rem;
  }
  .btn {
    -webkit-tap-highlight-color: transparent;
    border:1px solid var(--ring);
    background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 10%, #000 90%), #0000);
    color:var(--text);
    padding:.6rem .9rem; border-radius:.7rem;
    cursor:pointer; user-select:none;
    font-weight:600; letter-spacing:.25px;
    box-shadow: var(--shadow);
    transition: transform .08s ease, background .3s ease, opacity .3s ease;
  }
  .btn:hover { transform: translateY(-1px); }
  .btn:active { transform: translateY(1px) scale(.99); }
  .btn[disabled] { opacity:.55; cursor:not-allowed; }

  .seg {
    display:flex; gap:0;
    border:1px solid var(--ring);
    border-radius:.75rem; overflow:hidden;
    box-shadow: var(--shadow);
    background: #0000;
  }
  .seg button {
    background: #0000; color:var(--text);
    border:0; padding:.6rem .85rem; font-weight:700; letter-spacing:.2px;
    cursor:pointer; position:relative; isolation:isolate;
  }
  .seg button + button { border-left:1px solid var(--ring); }
  .seg button.active {
    background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 18%, #000 82%), #0000);
  }
  .seg button::after {
    content:''; position:absolute; inset:0;
    box-shadow: inset 0 0 0 1px color-mix(in oklab, var(--accent) 50%, #ffffff 20%);
    opacity:.0; transition:opacity .2s ease;
  }
  .seg button.active::after { opacity:.6; }

  /* Panels */
  .panes {
    display:grid; gap:1rem;
    grid-template-columns: 1fr;
  }
  .panel {
    background: linear-gradient(180deg, #ffffff0e, #00000000);
    border:1px solid var(--soft);
    border-radius:1rem; padding:1rem; box-shadow: var(--shadow);
  }

  .status {
    display:grid; gap:.6rem;
    grid-template-columns: 1fr;
  }
  .status-item {
    display:flex; align-items:center; justify-content:space-between; gap:.8rem;
    background: #00000020; border:1px dashed var(--soft);
    border-radius:.65rem; padding:.55rem .7rem;
  }
  .status-item .label { opacity:.88; font-weight:600; }
  .badge {
    font-weight:800; padding:.25rem .55rem; border-radius:.5rem; border:1px solid var(--soft);
    background: #00000040; letter-spacing:.3px;
  }
  .pass { color: var(--ok); border-color: color-mix(in oklab, var(--ok) 40%, #fff 60%); }
  .fail { color: var(--bad); border-color: color-mix(in oklab, var(--bad) 40%, #fff 60%); }
  .idle { color: var(--warn); border-color: color-mix(in oklab, var(--warn) 40%, #fff 60%); }

  .notes label { display:block; font-weight:700; margin-bottom:.4rem; color: var(--muted); }
  textarea {
    width:100%; min-height: 28svh; resize: vertical;
    background: #0000002a; color: var(--text);
    border:1px solid var(--soft); border-radius:.8rem;
    padding: .9rem 1rem; line-height:1.45; font-size:1rem;
    outline:none; box-shadow: var(--shadow);
  }
  textarea::placeholder { color: color-mix(in oklab, var(--muted) 70%, #fff 30%); }

  /* Canvas overlay */
  #overlay {
    position:fixed; inset:0;
    width:100vw; height:100svh;
    pointer-events:none; z-index:1;
    opacity:1; transition: opacity .8s ease;
  }

  footer {
    margin-top: 1.2rem; padding: 1.2rem 0 2rem;
    color: var(--muted);
    display:flex; align-items:center; gap:.7rem; justify-content:space-between;
    border-top: 1px solid var(--soft);
    font-weight:600; letter-spacing:.3px;
  }
  footer .sig { opacity:.9; }
  footer .midnight { opacity:.75; font-style:italic; }

  /* Appendix: Manifest table */
  .manifest table {
    width:100%; border-collapse: collapse; overflow:hidden; border-radius:.8rem;
    border:1px solid var(--soft);
  }
  .manifest th, .manifest td {
    text-align:left; padding:.7rem .8rem; border-bottom:1px solid var(--soft);
  }
  .manifest th {
    position:sticky; top:0; background: #00000030; backdrop-filter: blur(2px);
  }
  .manifest tr:last-child td { border-bottom:0; }
  .muted { color: var(--muted); }

  /* Reduce motion preference */
  @media (prefers-reduced-motion: reduce) {
    #overlay { transition:none; }
    .btn { transition: none; }
    .seg button::after { transition:none; }
  }
</style>
</head>
<body data-mode="marina">
  <canvas id="overlay" aria-hidden="true"></canvas>

  <div class="wrap" role="application" aria-label="Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color">
    <header>
      <div class="logo" aria-hidden="true">
        <!-- gold‚Äîsun glyph -->
        <svg viewBox="0 0 100 100" fill="none" stroke="#603d00" stroke-width="6" aria-hidden="true">
          <circle cx="50" cy="50" r="26" fill="rgba(255,255,255,.25)" stroke="rgba(255,255,255,.4)"/>
          <g stroke-linecap="round">
            <line x1="50" y1="3"  x2="50" y2="19"/>
            <line x1="50" y1="81" x2="50" y2="97"/>
            <line x1="3"  y1="50" x2="19" y2="50"/>
            <line x1="81" y1="50" x2="97" y2="50"/>
            <line x1="17" y1="17" x2="28" y2="28"/>
            <line x1="72" y1="72" x2="83" y2="83"/>
            <line x1="17" y1="83" x2="28" y2="72"/>
            <line x1="72" y1="28" x2="83" y2="17"/>
          </g>
        </svg>
      </div>
      <h1>
        Time ¬∑ Illumina v4 ‚Äî Kugelblitz of Color
        <span class="sub">scientific √ó spiritual √ó sensual</span>
      </h1>
    </header>

    <p class="note" aria-label="Malala note">
      ‚Äúyou are not in control ‚Äî yet you are chosen. you doubt, you fight, you float.‚Äù
    </p>

    <section class="controls" aria-label="Controls">
      <button class="btn" id="unlockAudio" aria-pressed="false">üîä Unlock Audio</button>
      <button class="btn" id="runSelfCheck">üß™ Run Self‚ÄëCheck</button>
      <div class="seg" role="tablist" aria-label="Mode toggles">
        <button role="tab" id="tab-marina"   class="active" data-mode="marina"   aria-selected="true">Marina</button>
        <button role="tab" id="tab-sigrid"   data-mode="sigrid"   aria-selected="false">Sigrid</button>
        <button role="tab" id="tab-clarity"  data-mode="clarity"  aria-selected="false">Clarity</button>
        <button role="tab" id="tab-illumina" data-mode="illumina" aria-selected="false">Illumina</button>
        <button role="tab" id="tab-kugelblitz" data-mode="kugelblitz" aria-selected="false">Kugelblitz</button>
      </div>
    </section>

    <div class="panes">
      <section class="panel notes" aria-label="Bee Notes">
        <label for="bee">üêù Bee Notes ‚Ä¢ <span id="modeName">Marina</span></label>
        <textarea id="bee" placeholder="Write with heat. Saved locally per mode ‚Äî bee.notes.marina|sigrid|clarity|illumina|kugelblitz"></textarea>
      </section>

      <section class="panel selfcheck" aria-live="polite" aria-label="Self-Check">
        <div class="status">
          <div class="status-item"><span class="label">Audio @ 128 Hz</span><span id="chk-audio" class="badge idle">idle</span></div>
          <div class="status-item"><span class="label">Timer drift &lt; ¬±30 ms</span><span id="chk-timer" class="badge idle">idle</span></div>
          <div class="status-item"><span class="label">Render loop loss &lt; 2</span><span id="chk-raf" class="badge idle">idle</span></div>
        </div>
      </section>

      <section class="panel manifest" aria-label="Appendix ¬∑ Illumina Manifest">
        <h2 style="margin:.2rem 0 0.6rem;font-size:1.05rem">Appendix ¬∑ Illumina Manifest</h2>
        <div class="muted" style="margin-bottom:.6rem">Schema ‚Üí replaced by a lucid table of modes, equations, rhythms, and Bee keys.</div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Mode</th>
                <th>Equation / Mantra</th>
                <th>Color ¬∑ Rhythm ¬∑ Overlay</th>
                <th>Bee Key</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Marina</td>
                <td>œÑ = E / c¬≥ ¬∑ œÜ</td>
                <td>gold ¬∑ rose ¬∑ clock‚Äëhands rotate every 1.618 s ‚Äî empathy as time</td>
                <td><code>bee.notes.marina</code></td>
              </tr>
              <tr>
                <td>Sigrid</td>
                <td>ŒîE = clarity¬≤ (‚àö2)</td>
                <td>sky‚Äësilver / blue ¬∑ aurora arc pulsing every 1.414 s ‚Äî precision as emotion</td>
                <td><code>bee.notes.sigrid</code></td>
              </tr>
              <tr>
                <td>Clarity</td>
                <td>160‚Üî432 Hz breath</td>
                <td>aqua‚Äëviolet ¬∑ jellyfish drift ‚âà 6 s ‚Äî faith in motion</td>
                <td><code>bee.notes.clarity</code></td>
              </tr>
              <tr>
                <td>Illumina</td>
                <td>42‚Äëday cycle</td>
                <td>deep purple starfield ‚Äî coherence / collective witness</td>
                <td><code>bee.notes.illumina</code></td>
              </tr>
              <tr>
                <td>Kugelblitz</td>
                <td>E ‚Üí ‚àû</td>
                <td>blue‚Äëinfinity gradient ¬∑ central pulse every 3 s (blue‚Üíwhite‚Üígold‚Üíviolet‚Üíred‚Äëheat)</td>
                <td><code>bee.notes.kugelblitz</code></td>
              </tr>
              <tr>
                <td colspan="4"><em>Page 42 = the harmonic midpoint ‚Äî light becomes witness; the Bee writes.</em></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <footer>
      <div class="sig">üêù page 42 ¬∑ eat the world</div>
      <div class="midnight">2025 midnight release</div>
    </footer>
  </div>

<script>
/* ==========================================================
   Illumina v4 ‚Äî Kugelblitz of Color (Heat Pulse Edition)
   All inline. No external libs. Cross-browser by design.
   ========================================================== */

(() => {
  const phi = (1 + Math.sqrt(5)) / 2; // 1.618...
  const root = document.documentElement;
  const body = document.body;
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d', { alpha: true });
  const DPR = () => Math.max(1, Math.min(3, (window.devicePixelRatio || 1)));

  let W = 0, H = 0, dpr = DPR();
  function fit() {
    dpr = DPR();
    W = Math.floor(window.innerWidth * dpr);
    H = Math.floor(window.innerHeight * dpr);
    canvas.width = W;
    canvas.height = H;
    canvas.style.width = '100vw';
    canvas.style.height = '100svh';
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
  }
  fit(); addEventListener('resize', fit, { passive:true });

  /* ---------- Modes & UI ---------- */
  const modes = ["marina","sigrid","clarity","illumina","kugelblitz"];
  const modeNameEl = document.getElementById('modeName');
  const bee = document.getElementById('bee');

  let mode = 'marina';
  let prevMode = null;
  let kugelFade = 1;       // opacity for Kugelblitz overlay
  let kugelFadeTarget = 1; // animate when leaving Kugelblitz

  function beeKey(m) { return `bee.notes.${m}`; }

  function loadBee(m) {
    let txt = '';
    try { txt = localStorage.getItem(beeKey(m)) || ''; } catch(e) {}
    bee.value = txt;
  }
  function saveBee() {
    try { localStorage.setItem(beeKey(mode), bee.value || ''); } catch(e) {}
  }
  bee.addEventListener('input', saveBee);

  function setMode(m) {
    if (m === mode) return;
    prevMode = mode;
    mode = m;
    body.setAttribute('data-mode', m);
    modeNameEl.textContent = m[0].toUpperCase() + m.slice(1);

    document.querySelectorAll('.seg [role="tab"]').forEach(b=>{
      const on = b.dataset.mode === m;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });

    if (prevMode === 'kugelblitz' && mode !== 'kugelblitz') {
      kugelFadeTarget = 0;
    } else if (mode === 'kugelblitz') {
      kugelFade = 0; kugelFadeTarget = 1; // fade in when entering
    } else {
      kugelFadeTarget = 1;
    }

    loadBee(m);
  }

  document.querySelectorAll('.seg [role="tab"]').forEach(b=>{
    b.addEventListener('click', () => setMode(b.dataset.mode));
  });

  // initial
  loadBee(mode);

  /* ---------- Audio (128 Hz unlock + test) ---------- */
  let audioCtx = null;
  let audioUnlocked = false;

  const btnUnlock = document.getElementById('unlockAudio');
  btnUnlock.addEventListener('click', async () => {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      // short, gentle blip @128 Hz to confirm unlock
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine'; osc.frequency.value = 128;
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.05, audioCtx.currentTime + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.3);
      audioUnlocked = true;
      btnUnlock.textContent = '‚úÖ Audio Unlocked';
      btnUnlock.setAttribute('aria-pressed', 'true');
      btnUnlock.disabled = true;
      markStatus('chk-audio', true, 'unlocked');
    } catch (e) {
      console.warn('Audio unlock failed', e);
      markStatus('chk-audio', false, 'error');
    }
  });

  /* ---------- Self‚ÄëCheck ---------- */
  const markStatus = (id, pass, text) => {
    const el = document.getElementById(id);
    el.classList.remove('idle','pass','fail');
    el.classList.add(pass ? 'pass' : 'fail');
    el.textContent = pass ? `pass ¬∑ ${text||''}`.trim() : `fail ¬∑ ${text||''}`.trim();
  };

  const btnSelf = document.getElementById('runSelfCheck');
  let blastMoment = 0; // >0 triggers global heat-blast
  btnSelf.addEventListener('click', async () => {
    // Reset visual markers
    ['chk-audio','chk-timer','chk-raf'].forEach(id=>{
      const el = document.getElementById(id);
      el.classList.remove('pass','fail'); el.classList.add('idle'); el.textContent='running‚Ä¶';
    });

    // 1) Audio @ 128 Hz
    let audioPass = false;
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.value = 128; osc.type='sine';
      gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.035, audioCtx.currentTime + 0.04);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.28);
      audioPass = true;
    } catch (e) {
      audioPass = false;
    }
    markStatus('chk-audio', audioPass, '128 Hz');

    // 2) Timer drift < ¬±30 ms (20 intervals of 50ms)
    const expected = 50;
    let maxAbsDrift = 0;
    let last = performance.now();
    for (let i=0;i<20;i++) {
      await new Promise(res=>setTimeout(res, expected));
      const now = performance.now();
      const delta = now - last;
      const drift = delta - expected;
      maxAbsDrift = Math.max(maxAbsDrift, Math.abs(drift));
      last = now;
    }
    const timerPass = maxAbsDrift <= 30;
    markStatus('chk-timer', timerPass, `${maxAbsDrift.toFixed(0)} ms`);

    // 3) rAF loss < 2 (count long frames > 33ms across ~1s)
    let longFrames = 0;
    let t0 = performance.now();
    let tPrev = t0;
    await new Promise(res=>{
      function sample(t){
        const dt = t - tPrev; tPrev = t;
        if (dt > 33) longFrames++;
        if (t - t0 < 1000) requestAnimationFrame(sample);
        else res();
      }
      requestAnimationFrame(sample);
    });
    const rafPass = longFrames < 2;
    markStatus('chk-raf', rafPass, `loss ${longFrames}`);

    // If all pass ‚Üí trigger Kugelblitz heat‚Äëblast
    if (audioPass && timerPass && rafPass) {
      blastMoment = performance.now(); // draw loop will consume
      // also show a dramatic pulse even if not in Kugelblitz
      // set a quick fade-in for kugelblitz layer (temporary)
      if (mode !== 'kugelblitz') {
        kugelFade = 0; kugelFadeTarget = 1;
        // Automatically relax the overlay after the blast fades
        setTimeout(()=> { kugelFadeTarget = 0.0; }, 1200);
      }
    }
  });

  /* ---------- Visual Systems (Canvas overlays) ---------- */

  // Shared utilities
  const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));
  const lerp = (a,b,t)=> a + (b-a)*t;
  const easeOutCubic = t => 1 - Math.pow(1-t,3);
  const TAU = Math.PI*2;

  function rgba(r,g,b,a){ return `rgba(${r|0},${g|0},${b|0},${clamp(a,0,1)})`; }
  function mixRGB(c1, c2, t) {
    const a = [ (c1>>16)&255, (c1>>8)&255, c1&255 ];
    const b = [ (c2>>16)&255, (c2>>8)&255, c2&255 ];
    const r = lerp(a[0], b[0], t), g = lerp(a[1], b[1], t), bl = lerp(a[2], b[2], t);
    return `rgb(${r|0},${g|0},${bl|0})`;
  }

  /* --- MARINA: œÜ clock (1.618 s rotation) --- */
  function drawMarina(t, alpha=1){
    const ctx2 = ctx;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.18;

    ctx2.save();
    ctx2.globalAlpha = 0.9*alpha;
    ctx2.translate(cx, cy);

    // Dial
    ctx2.beginPath(); ctx2.arc(0,0,r,0,TAU);
    ctx2.strokeStyle = 'rgba(246, 211, 110, 0.55)';
    ctx2.lineWidth = 2; ctx2.stroke();

    // œÜ marker
    ctx2.font = '600 28px system-ui, sans-serif';
    ctx2.textAlign = 'center'; ctx2.textBaseline='middle';
    ctx2.fillStyle = 'rgba(255,118,144,0.8)';
    ctx2.fillText('œÜ', 0, -r*0.6);

    // Hands
    const period = 1618; // ms
    const ang = (t % period) / period * TAU;
    const len1 = r*0.92, len2 = len1/phi;

    ctx2.rotate(ang);
    ctx2.strokeStyle = 'rgba(246, 211, 110, 0.95)';
    ctx2.lineWidth = 3; ctx2.beginPath(); ctx2.moveTo(0,0); ctx2.lineTo(len1,0); ctx2.stroke();
    ctx2.rotate(TAU/phi);
    ctx2.strokeStyle = 'rgba(255,118,144,0.85)';
    ctx2.lineWidth = 2; ctx2.beginPath(); ctx2.moveTo(0,0); ctx2.lineTo(len2,0); ctx2.stroke();

    ctx2.restore();
  }

  /* --- SIGRID: ‚àö2 aurora (1.414 s pulse) --- */
  function drawSigrid(t, alpha=1){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const ctx2 = ctx;
    const period = 1414;
    const p = (t % period) / period;
    const pulse = 0.35 + 0.65 * Math.sin(p * TAU); // 0..1

    const layers = 6;
    ctx2.save();
    ctx2.globalAlpha = alpha * 0.9;
    for (let i=0; i<layers; i++) {
      const y = h*0.2 + i* (h*0.06);
      const amp = 40 + i*12;
      const baseAlpha = 0.08 + (i/layers)*0.12 + pulse*0.08;
      const grad = ctx2.createLinearGradient(0,y, w,y);
      grad.addColorStop(0, `rgba(200,220,255,${baseAlpha})`);
      grad.addColorStop(0.5, `rgba(110,167,255,${baseAlpha*1.15})`);
      grad.addColorStop(1, `rgba(210,220,232,${baseAlpha})`);
      ctx2.fillStyle = grad;

      // curved band
      ctx2.beginPath();
      ctx2.moveTo(0, y);
      for (let x=0; x<=w; x+=24){
        const curve = Math.sin((x/w)*TAU* (1.0 + 0.2*Math.sin(t*0.0003))) * amp * (0.7 + 0.3*Math.sin(t*0.0005 + i));
        ctx2.lineTo(x, y + curve);
      }
      ctx2.lineTo(w, y+amp*1.6);
      ctx2.lineTo(0, y+amp*1.6);
      ctx2.closePath();
      ctx2.fill();
    }
    ctx2.restore();
  }

  /* --- CLARITY: Jellyfish drift (~6 s breath) --- */
  const jellies = [];
  function ensureJellies(){
    const target = 12;
    while (jellies.length < target) {
      jellies.push({
        x: Math.random(), y: Math.random(),
        r: lerp(28, 76, Math.random()),
        phase: Math.random()*TAU,
        hue: Math.random()
      });
    }
  }
  ensureJellies();

  function drawClarity(t, alpha=1){
    ensureJellies();
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const ctx2 = ctx;
    const breathT = (t % 6000) / 6000; // ~6 s
    const breath = 0.55 + 0.45*Math.sin(breathT*TAU);

    ctx2.save();
    ctx2.globalAlpha = alpha * 0.85;

    jellies.forEach(j=>{
      const driftX = Math.sin(t*0.0002 + j.phase)*0.004;
      const driftY = -0.015; // upward drift
      j.x = (j.x + driftX + 1) % 1;
      j.y = (j.y + driftY + 1) % 1;

      const x = j.x * w, y = j.y * h;
      const r = j.r * (0.8 + 0.35*breath);

      // bell
      const rad = ctx2.createRadialGradient(x, y, r*0.1, x, y, r);
      rad.addColorStop(0, 'rgba(8,255,215,0.55)');
      rad.addColorStop(0.5, 'rgba(140,94,255,0.35)');
      rad.addColorStop(1, 'rgba(140,94,255,0.0)');
      ctx2.fillStyle = rad;
      ctx2.beginPath(); ctx2.arc(x,y,r,0,TAU); ctx2.fill();

      // soft tentacles
      ctx2.lineWidth = 1.2;
      for (let k=0;k<6;k++){
        const ang = (k/6)*TAU + j.phase*0.2 + t*0.0004;
        const len = r * (0.9 + 0.2*Math.sin(t*0.001 + k));
        const x2 = x + Math.cos(ang)*len*0.6;
        const y2 = y + Math.sin(ang)*len*1.2;
        ctx2.strokeStyle = 'rgba(8,255,215,0.18)';
        ctx2.beginPath(); ctx2.moveTo(x, y + r*0.2); ctx2.quadraticCurveTo(x, y2, x2, y2); ctx2.stroke();
      }
    });

    ctx2.restore();
  }

  /* --- ILLUMINA: Deep purple starfield (42‚Äëday cycle) --- */
  const stars = [];
  function initStars(){
    stars.length = 0;
    const count = Math.ceil((canvas.clientWidth * canvas.clientHeight) / 9000);
    for (let i=0; i<count; i++){
      stars.push({
        x: Math.random(), y: Math.random(),
        r: Math.random()*1.6 + 0.2,
        sp: 0.6 + Math.random()*1.2,
        tw: Math.random()*TAU
      });
    }
  }
  initStars();
  addEventListener('resize', initStars, { passive:true });

  function drawIllumina(t, alpha=1){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const ctx2 = ctx;

    // 42‚Äëday global phase
    const days = Date.now() / 86400000;
    const cycle = (days % 42) / 42; // 0..1
    const hueMod = Math.sin(cycle * TAU) * 0.15 + 0.85; // 0.7..1.0

    ctx2.save();
    ctx2.globalAlpha = 0.9*alpha;

    stars.forEach(s=>{
      const x = s.x * w, y = s.y * h;
      const twinkle = 0.5 + 0.5*Math.sin(t*0.0015*s.sp + s.tw);
      const a = 0.25 + twinkle*0.6;
      const r = (s.r + twinkle*0.8);

      const g = ctx2.createRadialGradient(x,y,0.1, x,y,r*2.4);
      g.addColorStop(0, `rgba(${(180*hueMod)|0}, ${(150*hueMod)|0}, 255, ${a})`);
      g.addColorStop(1, `rgba(255, 255, 255, 0.0)`);
      ctx2.fillStyle = g;
      ctx2.beginPath(); ctx2.arc(x,y,r*2,0,TAU); ctx2.fill();
    });

    // a thin coherence ring
    ctx2.globalAlpha = alpha * 0.18;
    const cx = w/2, cy = h/2, R = Math.min(w,h)*0.28;
    ctx2.beginPath(); ctx2.arc(cx, cy, R + Math.sin(t*0.001)*6, 0, TAU);
    ctx2.strokeStyle = 'rgba(188,160,255,0.6)';
    ctx2.lineWidth = 1.2; ctx2.stroke();

    ctx2.restore();
  }

  /* --- KUGELBLITZ: Concentric radial pulse (3 s) --- */
  function gradientColor(phase){
    // Map phase 0..1 to blue‚Üíwhite‚Üígold‚Üíviolet‚Üíred‚Äëheat
    if (phase < 0.2) return {from:0x0c4cff, to:0x3da1ff};          // blue
    if (phase < 0.4) return {from:0xffffff, to:0xf8f8ff};          // white
    if (phase < 0.6) return {from:0xf5c84c, to:0xffd76f};          // gold
    if (phase < 0.8) return {from:0x8c5eff, to:0xb79aff};          // violet
    return {from:0xff3a24, to:0xff7f5c};                           // red‚Äëheat
  }

  function drawKugelblitz(t, alpha=1, extraBlast=0){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    const ctx2 = ctx;
    const cx = w/2, cy = h/2;
    const period = 3000;
    const ph = (t % period) / period;

    // radius grows and collapses
    const swell = easeOutCubic((Math.sin(ph*TAU - Math.PI/2) + 1)/2); // 0..1
    const baseR = Math.min(w,h) * (0.1 + 0.35*swell + 0.25*extraBlast);

    ctx2.save();
    ctx2.globalAlpha = alpha * (0.85 + 0.15*swell);

    // multiple rings
    for (let k=0; k<6; k++){
      const p = ((ph + k*0.12) % 1 + 1) % 1;
      const {from, to} = gradientColor(p);
      const r1 = baseR + k * 40 * (1 + 0.6*swell);
      const r2 = r1 + 90 + 35*Math.sin(t*0.003 + k);

      const g = ctx2.createRadialGradient(cx, cy, r1*0.1, cx, cy, r2);
      g.addColorStop(0, mixRGB(from, to, 0.25));
      g.addColorStop(0.6, mixRGB(from, to, 1.0));
      g.addColorStop(1, 'rgba(0,0,0,0)');

      ctx2.fillStyle = g;
      ctx2.beginPath(); ctx2.arc(cx, cy, r2, 0, TAU); ctx2.fill();
    }

    // white-hot core
    const coreR = baseR * (0.3 + 0.6*swell);
    const core = ctx2.createRadialGradient(cx, cy, 0, cx, cy, coreR);
    core.addColorStop(0, 'rgba(255,255,255,0.95)');
    core.addColorStop(1, 'rgba(255,255,255,0.0)');
    ctx2.fillStyle = core;
    ctx2.beginPath(); ctx2.arc(cx, cy, coreR, 0, TAU); ctx2.fill();

    ctx2.restore();
  }

  /* ---------- Global Heat‚ÄëBlast (after self‚Äëcheck pass) ---------- */
  function drawBlast(now){
    if (blastMoment <= 0) return 0;
    const t = (now - blastMoment);
    if (t > 1600) { blastMoment = 0; return 0; }
    const k = easeOutCubic(clamp(t/1200, 0, 1));
    return k; // as an "extraBlast" factor to Kugelblitz renderer
  }

  /* ---------- Render Loop ---------- */
  let last = performance.now();
  (function loop(now){
    const dt = now - last; last = now;

    // manage fade of kugelblitz overlay when leaving mode
    kugelFade += (kugelFadeTarget - kugelFade) * clamp(dt/220, 0, 1);
    if (Math.abs(kugelFade - kugelFadeTarget) < 0.002) kugelFade = kugelFadeTarget;

    ctx.clearRect(0,0, canvas.clientWidth, canvas.clientHeight);

    // Mode overlays
    if (mode === 'marina') {
      drawMarina(now, 1.0);
    } else if (mode === 'sigrid') {
      drawSigrid(now, 1.0);
    } else if (mode === 'clarity') {
      drawClarity(now, 1.0);
    } else if (mode === 'illumina') {
      drawIllumina(now, 1.0);
    } else if (mode === 'kugelblitz') {
      drawKugelblitz(now, kugelFade, 0);
    }

    // If we just left Kugelblitz, let it gently persist then fade
    if (prevMode === 'kugelblitz' && mode !== 'kugelblitz' && kugelFade > 0.01) {
      drawKugelblitz(now, kugelFade*0.7, 0);
    }

    // Heat‚Äëblast overlay if self‚Äëcheck passed
    const blastK = drawBlast(now);
    if (blastK > 0.001) {
      drawKugelblitz(now, 0.85, blastK*1.1);
    }

    requestAnimationFrame(loop);
  })(performance.now());

  /* ---------- Keyboard shortcuts ---------- */
  addEventListener('keydown', (e)=>{
    if (e.altKey || e.metaKey || e.ctrlKey) return;
    if (['ArrowRight','ArrowLeft'].includes(e.key)) {
      const idx = modes.indexOf(mode);
      const next = e.key === 'ArrowRight' ? (idx+1)%modes.length : (idx-1+modes.length)%modes.length;
      setMode(modes[next]);
    }
  }, {passive:true});

  /* ---------- Friendly welcome in console ---------- */
  try {
    console.log('%cIllumina v4 ¬∑ Kugelblitz','background:linear-gradient(90deg,#0c4cff,#ffffff,#f5c84c,#8c5eff,#ff3a24);color:#000;padding:6px 10px;border-radius:8px;font-weight:800;');
    console.log('sex = power ¬∑ energy = heat ¬∑ light = consciousness ‚Äî elegant, safe, luminous.');
  } catch(_) {}

})();
</script>
</body>
</html>
